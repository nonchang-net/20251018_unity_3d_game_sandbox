# カメラ仕様

このドキュメントは、ゲーム内のカメラシステムの実装仕様を説明します。

## 概要

カメラシステムは、プレイヤーキャラクターを追跡するサードパーソンカメラを実装しており、以下の3つのコンポーネントで構成されています。

- **CharacterTracker**: カメラのトラッキング処理と視点制御を担当
- **GameCameraManager**: カメラ状態の管理とトラッキング設定の切り替えを担当
- **TrackingSetting**: カメラパラメータをScriptableObjectとして保存

## コンポーネントの役割

### CharacterTracker

Main Cameraオブジェクトにアタッチして使用するコンポーネントです。

**主な責務:**
- ターゲット（プレイヤー）の追跡
- プレイヤー入力に基づくカメラ回転処理（Yaw/Pitch制御）
- カメラ位置の計算と更新
- 障害物回避処理
- TrackingSettingに基づくカメラパラメータの適用
- カメラ回転固定（ロック）機能の実装
- キャラクター移動方向の計算用のカメラ方向ベクトル提供

**重要な処理:**
- `HandleCameraRotation()`: プレイヤーの視点入力を受け取り、カメラのYaw/Pitch角度を更新
- `UpdateCameraPosition()`: カメラの理想位置を計算し、障害物回避を考慮して実際の位置を決定
- `GetCameraForward()` / `GetCameraRight()`: カメラのYaw角から直接計算した方向ベクトルを提供（キャラクター移動方向の計算に使用）

### GameCameraManager

カメラ全体の状態を管理するコンポーネントです。

**主な責務:**
- カメラの水中判定とCameraStateの更新
- トラッキング設定の切り替え（Zキー入力）
- トラッキング設定切り替え時のトランジションアニメーション制御
- CameraLockArea進入・退出時の一時的なトラッキング設定の適用
- R3を使用したイベント駆動型の処理

**重要な処理:**
- `CheckWaterState()`: カメラが水面下にあるかを判定し、GameStateManagerに通知
- `SwitchToNextTrackingSetting()`: 次のトラッキング設定に切り替え
- `UpdateTransition()`: トランジション中にTrackingSettingの値を補間してCharacterTrackerに適用
- `SetTemporaryTrackingSettings()`: CameraLockArea用の一時設定を適用
- `ClearTemporaryTrackingSettings()`: 一時設定をクリアして元の設定に戻す

### TrackingSetting

カメラトラッキングのパラメータをまとめたScriptableObjectです。

**保持するパラメータ:**
- カメラ距離・高さ・ピッチ角の制限
- 障害物回避の設定（有効/無効、判定レイヤー、スムージング速度など）
- カメラスムージングパラメータ
- カメラリセット時の設定
- **カメラロック設定**（LockCameraRotation, LockedCameraRotation, DisableVerticalInput, MaintainYawOnUnlock）

## データフロー

```
プレイヤー入力（Look入力）
  ↓
GameInputManager
  ↓
CharacterTracker.SetLookInput()
  ↓
CharacterTracker.HandleCameraRotation()
  ↓
cameraYaw / cameraPitch を更新
  ↓
CharacterTracker.UpdateCameraPosition()
  ↓
カメラ位置・回転の更新
```

```
Zキー入力（カメラビュー切り替え）
  ↓
GameInputManager
  ↓
GameStateManager.RequestNextCameraView()
  ↓
GameCameraManager（R3購読）
  ↓
SwitchToNextTrackingSetting()
  ↓
CharacterTracker.SetTrackingSetting()
```

```
CameraLockArea進入
  ↓
GameCharacterCollisionTrigger.OnTriggerEnter()
  ↓
GameStateManager.EnterCameraLockArea()
  ↓
GameCameraManager（R3購読）
  ↓
SetTemporaryTrackingSettings()
  ↓
CharacterTracker.SetTrackingSetting()
```

## 主要機能

### 1. カメラトラッキング

CharacterTrackerは、ターゲット（プレイヤー）を追跡し、指定された距離と高さからキャラクターを見下ろすようにカメラを配置します。

- カメラの理想位置は、ターゲット位置 + 高さオフセット - (Yaw/Pitchから計算したオフセット)
- 位置と距離にスムージングを適用して滑らかな動きを実現

### 2. カメラ回転制御

プレイヤーの視点入力（Look入力）に基づいて、カメラのYaw（水平回転）とPitch（垂直回転）を制御します。

- Pitch角度は`MinPitch`～`MaxPitch`の範囲に制限
- 上下反転設定（InvertVerticalAxis）に対応
- マウス感度倍率の調整に対応

### 3. カメラロック機能

TrackingSettingの`LockCameraRotation`フラグが有効な場合、カメラの回転を固定します。

**関連パラメータ:**
- `LockCameraRotation`: カメラ回転を固定するか（2Dゲーム風の操作）
- `LockedCameraRotation`: カメラ固定時の角度（Euler Angles）
- `DisableVerticalInput`: カメラ固定時に上下方向の入力を無効化するか
- `MaintainYawOnUnlock`: カメラロック解除時にYaw角度を維持するか

**動作:**
- カメラロック中は、プレイヤーの視点入力を無視し、`LockedCameraRotation`で指定された角度を使用
- `DisableVerticalInput`が有効な場合、GameInputManagerが上下方向の移動入力（W/S）を無効化
- ロック解除時に`MaintainYawOnUnlock`が有効な場合、現在のカメラYaw角度を維持（移動方向の急変を防止）

### 4. トラッキング設定切り替え

GameCameraManagerは、複数のTrackingSettingを保持し、プレイヤーのZキー入力で切り替えることができます。

**切り替え処理:**
1. `togglableTrackingSettings`配列から次の設定を取得（循環）
2. トランジションが有効な場合は、アニメーション付きで切り替え
3. トランジション無効の場合は、即座に切り替え

### 5. トランジションアニメーション

トラッキング設定切り替え時に、カメラパラメータを滑らかに補間するアニメーション機能です。

**仕組み:**
- `StartTransition()`でトランジション開始
- `UpdateTransition()`で毎フレーム進行度を更新（0.0 ～ 1.0）
- 数値パラメータ（距離、高さ、角度など）は`Mathf.Lerp()`で補間
- bool値やLayerMaskは、進行度50%時点で切り替え
- 補間された値を`CharacterTracker.SetTransitionValues()`で適用
- `CompleteTransition()`でトランジション完了、最終設定を適用

### 6. CameraLockArea機能

特定のエリアに進入すると、一時的にトラッキング設定を切り替える機能です。

**仕組み:**
1. CameraLockAreaタグのトリガーに進入
2. GameCharacterCollisionTriggerがCameraLockerコンポーネントからTrackingSetting配列を取得
3. GameStateManager経由でGameCameraManagerに通知
4. `SetTemporaryTrackingSettings()`で一時設定を適用
5. Zキーでの切り替え対象がこの一時設定配列に差し替わる
6. トリガーから退出時に`ClearTemporaryTrackingSettings()`で元の設定に戻る

**カスタムトランジション:**
- CameraLockArea進入・退出時は、`cameraLockAreaTransitionDuration`（デフォルト0.8秒）でトランジション
- 通常のZキー切り替えとは異なるトランジション時間を使用可能

### 7. 障害物回避

カメラとターゲットの間に障害物がある場合、カメラを手前に移動させる機能です。

**処理:**
- ターゲットからカメラの理想位置へRaycastを実行
- 障害物が見つかった場合、`cameraRadius`を考慮した安全な距離を計算
- `collisionSmoothSpeed`でスムーズに距離を調整
- プレイヤー自身やコイン（Coinタグ）は無視

### 8. キャラクター移動方向の計算

CharacterTrackerは、`GetCameraForward()`と`GetCameraRight()`メソッドで、キャラクターの移動方向計算に必要なカメラ方向ベクトルを提供します。

**重要な実装詳細:**
- カメラの実際の`transform.forward/right`ではなく、`cameraYaw`角度から三角関数を使って直接計算
- これにより、カメラ回転のスムージング遅延の影響を受けない正確な移動方向を提供
- カメラロック時は`lockedCameraRotation.y`を使用、通常時は`cameraYaw`を使用

**計算式:**
```csharp
// 前方向ベクトル
float yawRad = yaw * Mathf.Deg2Rad;
Vector3 forward = new Vector3(Mathf.Sin(yawRad), 0f, Mathf.Cos(yawRad));

// 右方向ベクトル
Vector3 right = new Vector3(Mathf.Cos(yawRad), 0f, -Mathf.Sin(yawRad));
```

この実装により、カメラ距離が大きい場合でもキャラクターが画面外に出ることなく、入力方向に正確に移動できます。

## 処理の流れ

### 初期化フロー

1. `CharacterTracker.Start()`: 初期角度設定、カメラ位置の初期化、カーソルロック
2. `GameCameraManager.Start()`: 初期TrackingSettingの適用、R3イベント購読

### 毎フレームの処理フロー（CharacterTracker）

1. `LateUpdate()`: カメラ処理は他のオブジェクトの移動後に実行
2. `HandleCameraRotation()`: 視点入力からYaw/Pitchを更新（ロック時はスキップ）
3. `UpdateCameraPosition()`: カメラの理想位置を計算
4. 障害物回避のRaycast処理
5. カメラ距離と位置のスムージング
6. カメラの位置と回転を設定

### 毎フレームの処理フロー（GameCameraManager）

1. `Update()`: 水中判定とトランジション処理
2. `CheckWaterState()`: カメラのY座標と水面高さを比較、状態変化時にGameStateManagerに通知
3. `UpdateTransition()`: トランジション中の場合、進行度に応じてパラメータを補間

## 関連ファイル

- `Assets/Scripts/Camera/CharacterTracker.cs`
- `Assets/Scripts/Camera/GameCameraManager.cs`
- `Assets/Scripts/Camera/TrackingSetting.cs`
- `Assets/Scripts/GameManager/GameInputManager.cs`（入力受付）
- `Assets/Scripts/Character/GameCharacterCollisionTrigger.cs`（CameraLockArea検出）
