# キャラクター管理仕様

このドキュメントは、プレイ可能なキャラクターの管理システムの実装仕様を説明します。

## 概要

キャラクター管理システムは、プレイ可能なキャラクターの登録・管理・切り替えを実装しており、主にPlayableCharacterRepositoryコンポーネントで構成されています。

- **PlayableCharacterRepository**: プレイ可能なキャラクターのリポジトリパターン実装

## コンポーネントの役割

### PlayableCharacterRepository

プレイ可能なキャラクターを管理するリポジトリコンポーネントです。

**主な責務:**
- ヒエラルキー上の初期化済みキャラクターの登録
- 起動時にVRMファイルを読み込んで登録
- VRMロード時に動的にキャラクターを登録
- キャラクター切り替え機能のデータソースとして機能
- 登録されたキャラクターの検索・取得

**重要な処理:**
- `Awake()`: GameManagerの自動検出、初期キャラクターの登録
- `Start()`: 起動時VRM読み込み処理の開始
- `LoadStartupVrmCharacter()`: StreamingAssetsからVRMファイルを読み込んでセットアップ
- `RegisterCharacter()`: キャラクターをリストの末尾に登録
- `RegisterCharacterAtFront()`: キャラクターをリストの先頭に登録（VRM読み込み時に使用）
- `UnregisterCharacter()`: キャラクターの登録を解除
- `GetAllCharacters()`: 登録されているすべてのキャラクターを取得
- `GetCharacterAt()`: インデックスを指定してキャラクターを取得
- `GetCharacterIndex()`: キャラクターのインデックスを取得
- `GetNextCharacterIndex()`: 次のキャラクターのインデックスを取得（循環）

## データ構造

### 登録キャラクターリスト

```csharp
private List<GameObject> registeredCharacters = new List<GameObject>();
```

- プレイ可能なキャラクターをGameObjectとして保持
- 登録順序を維持（リストの順序でキャラクター切り替え）
- 重複登録を防止

### 初期化完了フラグ

```csharp
private bool isInitialized = false;
```

- 起動時VRM読み込みの完了を追跡
- 他のコンポーネントから`IsInitialized()`で確認可能

## 主要機能

### 1. 初期キャラクターの登録

シーン起動時に、Inspectorで設定された初期キャラクターを自動登録します。

**設定:**
- `initialCharacters`: シーン起動時に登録する初期キャラクターの配列

**処理:**
```csharp
if (initialCharacters != null)
{
    foreach (var character in initialCharacters)
    {
        if (character != null)
        {
            RegisterCharacter(character);
        }
    }
}
```

### 2. 起動時VRM読み込み

シーン起動時に、StreamingAssetsフォルダからVRMファイルを読み込んで登録する機能です。

**設定:**
- `loadStartupVrmCharacter`: 起動時にデフォルトのVRMキャラクターを読み込むか
- `startupVrmFileName`: StreamingAssets内のVRMファイル名（デフォルト: "AliciaSolid.vrm"）
- `enableVerboseLog`: 詳細ログを表示するか

**処理の流れ:**
1. `Start()`で`LoadStartupVrmCharacter()`コルーチンを開始
2. StreamingAssetsからVRMファイルのパスを構築
3. ファイルの存在確認
4. スポーン位置を決定（GameManagerのDefaultSpawnPointから取得）
5. GameCharacterManagerからAnimatorControllerとPhysicsMaterialを取得
6. `VRMUtility.LoadAndSetupVrmFromPath()`でVRMを読み込んでセットアップ
7. `PrefabUtility.SetupGameManagedComponent()`でGameManaged系コンポーネントをセットアップ
8. `RegisterCharacterAtFront()`でリストの先頭に登録
9. `GameManager.SetActiveCharacter()`でアクティブキャラクターに設定
10. `isInitialized = true`で初期化完了

**エラーハンドリング:**
- VRMファイルが見つからない場合: エラーログ出力、初期化完了フラグを立てて継続
- VRM読み込みエラー: エラーログ出力、初期化完了フラグを立てて継続

### 3. キャラクター登録

プレイ可能なキャラクターをリポジトリに登録する機能です。

#### 3.1 末尾に登録

```csharp
public bool RegisterCharacter(GameObject character)
```

- キャラクターをリストの末尾に追加
- 重複チェックを実施（既に登録されている場合は警告）
- null チェックを実施

#### 3.2 先頭に登録

```csharp
public bool RegisterCharacterAtFront(GameObject character)
```

- キャラクターをリストの先頭に追加
- VRM読み込み時に使用（最新のキャラクターを優先）
- 重複チェックとnullチェックを実施

**使い分け:**
- `RegisterCharacter()`: 初期キャラクター、順序を維持したい場合
- `RegisterCharacterAtFront()`: VRM読み込みなど、新しいキャラクターを優先したい場合

### 4. キャラクター登録解除

```csharp
public bool UnregisterCharacter(GameObject character)
```

- キャラクターをリストから削除
- 登録されていない場合は警告
- nullチェックを実施

**使用例:**
- キャラクターをシーンから削除する時
- キャラクター切り替え機能から除外したい時

### 5. キャラクター検索・取得

#### 5.1 すべてのキャラクターを取得

```csharp
public IReadOnlyList<GameObject> GetAllCharacters()
```

- 登録されているすべてのキャラクターを読み取り専用リストで返す
- UI表示やキャラクター一覧表示に使用

#### 5.2 インデックスでキャラクターを取得

```csharp
public GameObject GetCharacterAt(int index)
```

- 指定されたインデックスのキャラクターを取得
- 無効なインデックスの場合はnullを返し、警告を出力

#### 5.3 キャラクターのインデックスを取得

```csharp
public int GetCharacterIndex(GameObject character)
```

- 指定されたキャラクターのインデックスを取得
- 登録されていない場合は-1を返す

#### 5.4 次のキャラクターのインデックスを取得

```csharp
public int GetNextCharacterIndex(int currentIndex)
```

- 現在のインデックスから次のインデックスを計算（循環）
- キャラクター切り替え機能で使用
- リストが空の場合は-1を返す

**実装:**
```csharp
return (currentIndex + 1) % registeredCharacters.Count;
```

### 6. キャラクター登録状態の確認

#### 6.1 登録されているかを確認

```csharp
public bool IsRegistered(GameObject character)
```

- キャラクターが登録されているかを確認
- nullチェックも実施

#### 6.2 登録数を取得

```csharp
public int GetCharacterCount()
```

- 登録されているキャラクターの数を取得

#### 6.3 すべてのキャラクター登録を解除

```csharp
public void ClearAllCharacters()
```

- すべてのキャラクターの登録を解除
- リセット処理などで使用

## データフロー

### 初期化フロー（起動時VRM読み込みあり）

```
PlayableCharacterRepository.Awake()
  ↓
initialCharactersをRegisterCharacter()で登録
  ↓
PlayableCharacterRepository.Start()
  ↓
LoadStartupVrmCharacter()コルーチン開始
  ↓
StreamingAssetsからVRMファイルパスを構築
  ↓
VRMUtility.LoadAndSetupVrmFromPath()
  ↓
VRM読み込み・セットアップ完了（onComplete）
  ↓
PrefabUtility.SetupGameManagedComponent()
  ↓
RegisterCharacterAtFront()でリストの先頭に登録
  ↓
GameManager.SetActiveCharacter()
  ↓
isInitialized = true
```

### 初期化フロー（起動時VRM読み込みなし）

```
PlayableCharacterRepository.Awake()
  ↓
initialCharactersをRegisterCharacter()で登録
  ↓
PlayableCharacterRepository.Start()
  ↓
isInitialized = true（即座に完了）
```

### VRM動的読み込みフロー（VRMLoadManager経由）

```
VRMLoadManager.OpenLoadVrmFileDialog()
  ↓
ファイル選択ダイアログ
  ↓
VRMUtility.LoadAndSetupVrmFromPath()
  ↓
VRM読み込み・セットアップ完了
  ↓
PrefabUtility.SetupGameManagedComponent()
  ↓
PlayableCharacterRepository.RegisterCharacterAtFront()
  ↓
GameManager.SetActiveCharacter()
```

### キャラクター切り替えフロー（RuntimeCharacterSwitcher経由）

```
RuntimeCharacterSwitcher.SwitchToNextCharacter()
  ↓
PlayableCharacterRepository.GetCharacterIndex()で現在のインデックスを取得
  ↓
PlayableCharacterRepository.GetNextCharacterIndex()で次のインデックスを取得
  ↓
PlayableCharacterRepository.GetCharacterAt()で次のキャラクターを取得
  ↓
GameManager.SetActiveCharacter()
```

## VRMUtilityとの連携

PlayableCharacterRepositoryは、VRMUtilityと連携してVRMファイルの読み込みとセットアップを行います。

**VRMUtility.LoadAndSetupVrmFromPath()の処理:**
1. VRMファイルの非同期読み込み
2. キャラクターのインスタンス化
3. CharacterController / Rigidbody + Collider のセットアップ
4. AnimatorControllerの適用
5. PhysicsMaterialの適用
6. GameCharacterCollisionTriggerの追加
7. onCompleteコールバックの呼び出し

**PrefabUtility.SetupGameManagedComponent()の処理:**
- GameManaged系コンポーネント（IGameManagedインターフェース実装）にGameManagerを設定

## RuntimeCharacterSwitcherとの連携

PlayableCharacterRepositoryは、RuntimeCharacterSwitcherのデータソースとして機能します。

**RuntimeCharacterSwitcherの機能:**
- Vキー入力で次のキャラクターに切り替え
- PlayableCharacterRepositoryから登録キャラクターを取得
- 現在のキャラクターのインデックスを追跡
- 次のインデックスを計算（循環）
- GameManager.SetActiveCharacter()でキャラクター切り替え

## 設計パターン

### リポジトリパターン

PlayableCharacterRepositoryは、リポジトリパターンを実装しています。

**利点:**
- データアクセスロジックの集約
- 登録・検索・削除の一貫したインターフェース
- 他のコンポーネントからの利用が容易
- テスタビリティの向上

**実装の特徴:**
- 内部リスト（`registeredCharacters`）の直接操作を防止
- 読み取り専用リスト（`IReadOnlyList`）で外部に公開
- 重複チェック・nullチェックを内部で実施

### コルーチンによる非同期処理

起動時VRM読み込みは、コルーチンを使用した非同期処理で実装されています。

**利点:**
- ファイル読み込み中もゲームがフリーズしない
- 読み込み完了後の処理をonCompleteコールバックで実装
- エラーハンドリングをonErrorコールバックで実装

## 設定項目

### 初期キャラクター設定

- **initialCharacters**: シーン起動時に登録する初期キャラクターの配列

### 起動時VRM読み込み設定

- **loadStartupVrmCharacter**: 起動時にデフォルトのVRMキャラクターを読み込むか（デフォルト: false）
- **startupVrmFileName**: StreamingAssets内のVRMファイル名（デフォルト: "AliciaSolid.vrm"）

### デバッグ設定

- **enableVerboseLog**: 詳細ログを表示するか（デフォルト: false）

## 使用例

### キャラクターの登録

```csharp
PlayableCharacterRepository repository = FindFirstObjectByType<PlayableCharacterRepository>();
repository.RegisterCharacter(myCharacter);
```

### すべてのキャラクターを取得

```csharp
IReadOnlyList<GameObject> characters = repository.GetAllCharacters();
foreach (var character in characters)
{
    Debug.Log(character.name);
}
```

### 次のキャラクターに切り替え

```csharp
int currentIndex = repository.GetCharacterIndex(currentCharacter);
int nextIndex = repository.GetNextCharacterIndex(currentIndex);
GameObject nextCharacter = repository.GetCharacterAt(nextIndex);
gameManager.SetActiveCharacter(nextCharacter);
```

## 関連ファイル

- `Assets/Scripts/Character/PlayableCharacterRepository.cs`
- `Assets/Scripts/Utility/VRMUtility.cs`（VRM読み込み・セットアップ）
- `Assets/Scripts/Utility/PrefabUtility.cs`（GameManaged系コンポーネントのセットアップ）
- `Assets/Scripts/Character/RuntimeCharacterSwitcher.cs`（キャラクター切り替え機能）
- `Assets/Scripts/Character/VRMLoadManager.cs`（VRM動的読み込み機能）
- `Assets/Scripts/GameManager/GameManager.cs`（アクティブキャラクター管理）
