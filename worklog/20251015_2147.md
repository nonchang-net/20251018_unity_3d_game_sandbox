# 作業レポート 2025-10-15 21:47

## 変更内容の概要

- Lキーからの動的VRM読み込み時に「一瞬正常な位置に生成されてからメッシュが高い位置に移動する」問題に対処しました
- VRMUtility.SetupVrmCharacter()の複数箇所で位置を再確認・再設定する処理を追加しました
- GameManager側のフレーム待機後にも位置を再確認・再設定する処理を追加しました

## 変更理由

ユーザーからの報告で、「Lキー読み込み時は、一瞬正常な位置に生成されてからメッシュ位置が高い位置に移動している」ことが判明しました。

これは初期配置は正しいが、その後の処理（Animator初期化、Rigidbody追加、フレーム待機など）でGameObjectまたはメッシュの位置がずれることを示唆しています。

そこで、以下の複数のタイミングで位置を再確認・再設定する処理を追加しました：

1. **Animator設定後**: AnimatorがRuntimeAnimatorControllerを適用する際、Tポーズやデフォルトポーズにリセットされる可能性があるため
2. **SetupVrmCharacter()の最後**: すべてのコンポーネント追加後に最終的な位置を確実に設定
3. **GameManager側のフレーム待機後**: UniTask.Yield()で2フレーム待機した後、物理演算などで位置がずれた場合に再設定

この多段階の位置確認により、どのタイミングで位置がずれても正しい位置に戻すことができるようになります。

## 変更したファイル

### Assets/Scripts/Utilities/VRMUtility.cs

1. **SetupVrmCharacter() (180-188行目):**
   - Animator設定後に位置を再確認
   - 位置がずれていた場合は再設定してログ出力

2. **SetupVrmCharacter() (204-206行目):**
   - すべてのコンポーネント追加後、最後にもう一度位置と回転を確実に設定
   - rotationも Quaternion.identity に設定

3. **SetupVrmCharacter() (216行目):**
   - 最終確認ログに最終位置を追加

### Assets/Scripts/GameManager/GameManager.cs

1. **LoadVrmFromFileAsync() (363-375行目):**
   - フレーム待機後に位置を再確認
   - 位置がずれていた場合は再設定してログ出力

2. **LoadVrmFromBytesAsync() (544-556行目):**
   - フレーム待機後に位置を再確認
   - 位置がずれていた場合は再設定してログ出力

## テスト方法

1. Unityエディタで実行
2. Lキーを押してVRMファイルを選択
3. キャラクターが正しい位置（DefaultSpawnPointの位置）に表示されるか確認
4. 詳細ログを確認して、どのタイミングで位置修正が発生したかを確認
