# 作業レポート 2025-10-16 01:45

## 変更内容の概要

- RuntimeCharacterSwitcherコンポーネントを新規作成し、キャラクター切り替え機能を完全に分離しました
- GameManagerからキャラクター切り替えに関するすべてのコードを削除しました
- GameManagerは「アクティブキャラクターの管理API」のみを提供し、切り替えロジックについて一切関知しない設計になりました

## 変更理由

ユーザーからの要望「Runtime Character Switcherコンポーネントを作成し、タブキーでキャラを切り替える機能を移動する」に対応しました。

従来のGameManagerは、以下のようにキャラクター切り替え機能を内包していました：
- タブキーの入力検出
- 次のキャラクターの計算
- キャラクター切り替えの実行

この設計では、GameManagerが「入力処理」「ロジック」「実行」の3つの責務を持っており、単一責任原則に違反していました。

RuntimeCharacterSwitcherを作成することで、以下のメリットが得られます：

1. **責務の完全な分離**:
   - GameManager: 「アクティブキャラクターの設定API」のみ提供
   - RuntimeCharacterSwitcher: 「入力検出とキャラクター切り替えロジック」を担当

2. **柔軟な入力設定**:
   - キャラクター切り替えキーを変更したい場合、RuntimeCharacterSwitcherのみを変更すればよい
   - GameManagerは影響を受けない

3. **機能の拡張性**:
   - 前のキャラクターへの切り替え
   - 名前によるキャラクター切り替え
   - UIボタンからの切り替え
   - これらの機能をRuntimeCharacterSwitcherに追加でき、GameManagerは無関係

4. **オプショナルな機能**:
   - キャラクター切り替え機能が不要なシーンでは、RuntimeCharacterSwitcherコンポーネントを配置しなければよい
   - GameManagerは常に必要だが、Switcherは任意

## 変更したファイル

### 新規作成: Assets/Scripts/Character/RuntimeCharacterSwitcher.cs

キャラクター切り替え機能を専門に扱うコンポーネントを作成しました。

**設計の特徴:**

1. **依存関係の自動解決**:
   ```csharp
   void Awake()
   {
       // GameManagerとPlayableCharacterRepositoryを自動検出
       if (gameManager == null)
       {
           gameManager = FindFirstObjectByType<GameManager>();
       }
       if (characterRepository == null)
       {
           characterRepository = FindFirstObjectByType<PlayableCharacterRepository>();
       }
   }
   ```

2. **入力処理**:
   ```csharp
   void Update()
   {
       if (Input.GetKeyDown(switchCharacterKey))
       {
           SwitchToNextCharacter();
       }
   }
   ```

3. **切り替えロジック**:
   - PlayableCharacterRepositoryから次のキャラクターを取得
   - GameManager.SetActiveCharacter()を呼び出して切り替え
   - エラーハンドリングと詳細ログ

**提供する機能:**

1. `SwitchToNextCharacter()` - 次のキャラクターに切り替え（循環）
2. `SwitchToPreviousCharacter()` - 前のキャラクターに切り替え（循環）
3. `SwitchToCharacter(int index)` - インデックス指定で切り替え
4. `SwitchToCharacterByName(string name)` - 名前指定で切り替え

**エラーハンドリング:**
- GameManagerが未設定の場合の警告
- PlayableCharacterRepositoryが未設定の場合の警告
- 切り替え可能なキャラクターが0体の場合の警告
- 切り替え可能なキャラクターが1体のみの場合のスキップ（冗長な処理を回避）

### 変更: Assets/Scripts/GameManager/GameManager.cs

GameManagerからキャラクター切り替え機能を完全に削除しました。

**削除したコード:**

1. **フィールド (45-47行目):**
   ```csharp
   // 削除
   [Header("キャラクター切り替え設定")]
   [Tooltip("キャラクター切り替えキー")]
   [SerializeField] private KeyCode switchCharacterKey = KeyCode.Tab;
   ```

2. **Update()内の入力処理 (189-193行目):**
   ```csharp
   // 削除
   if (Input.GetKeyDown(switchCharacterKey))
   {
       SwitchToNextCharacter();
   }
   ```

3. **SwitchToNextCharacter()メソッド (432-463行目):**
   - 完全に削除（RuntimeCharacterSwitcherに移動）

4. **SwitchToCharacter(int index)メソッド (465-482行目):**
   - 完全に削除（RuntimeCharacterSwitcherに移動）

**更新したドキュメント:**

クラスのサマリーコメントを更新し、責務を明確化：
```csharp
/// <summary>
/// ゲーム全体を管理するマネージャークラス
/// - アクティブキャラクターの管理
/// - カメラとキャラクター操作の自動連携
/// - VRM読み込み管理
/// </summary>
```

**残したAPI:**

GameManagerは以下のAPIのみを提供します：

1. `SetActiveCharacter(GameObject character)` - アクティブキャラクターを設定
   - カメラの追跡対象を自動設定
   - 入力管理の対象キャラクターを自動設定
   - 外部（RuntimeCharacterSwitcher等）から呼び出される

2. `GetActiveCharacter()` - 現在のアクティブキャラクターを取得

3. `GetCharacterRepository()` - PlayableCharacterRepositoryへの参照を取得

4. `GetInputManager()` - GameInputManagerへの参照を取得

## アーキテクチャの改善

### 変更前の責務分担

**GameManager:**
- ゲーム全体の管理
- **キャラクター切り替えキーの検出**
- **次のキャラクターの計算**
- **キャラクター切り替えの実行**
- アクティブキャラクターの管理
- カメラ・入力の連携

**PlayableCharacterRepository:**
- キャラクター一覧の管理
- インデックス計算のヘルパー

### 変更後の責務分担

**GameManager:**
- ゲーム全体の管理
- **アクティブキャラクター設定APIの提供**（SetActiveCharacter）
- カメラ・入力の連携
- VRM読み込み管理

**RuntimeCharacterSwitcher（新規）:**
- **キャラクター切り替えキーの検出**
- **次のキャラクターの計算**
- **キャラクター切り替えの実行**（GameManager.SetActiveCharacterを呼び出し）

**PlayableCharacterRepository:**
- キャラクター一覧の管理
- インデックス計算のヘルパー

### データフローの変更

**変更前:**
```
User Input (Tab)
  → GameManager.Update()
  → GameManager.SwitchToNextCharacter()
  → PlayableCharacterRepository (次のキャラクター取得)
  → GameManager.SetActiveCharacter()
```

**変更後:**
```
User Input (Tab)
  → RuntimeCharacterSwitcher.Update()
  → RuntimeCharacterSwitcher.SwitchToNextCharacter()
  → PlayableCharacterRepository (次のキャラクター取得)
  → GameManager.SetActiveCharacter() (外部から呼び出し)
```

## 設計の利点

### 1. 単一責任原則の遵守

**GameManager:**
- 「ゲーム全体の調整役」として、各コンポーネントを連携させる
- 「アクティブキャラクター」という状態を管理
- **切り替えロジックは持たない**

**RuntimeCharacterSwitcher:**
- 「キャラクター切り替え」という単一の責務に特化
- 入力検出、ロジック、実行のすべてを担当
- GameManagerの実装詳細を知らない（APIのみを使用）

### 2. オープン・クローズド原則

**拡張に開かれている:**
- RuntimeCharacterSwitcherに新しい切り替え方法を追加できる
  - 例: SwitchToRandomCharacter()
  - 例: SwitchToFavoriteCharacter()
- GameManagerを一切変更せずに拡張可能

**修正に閉じている:**
- GameManagerは安定したAPIを提供するのみ
- 切り替えロジックの変更はGameManagerに影響しない

### 3. 依存性逆転の原則

RuntimeCharacterSwitcherはGameManagerの具体的な実装に依存せず、公開APIのみに依存します：
```csharp
// 具体的な実装を知らない
gameManager.SetActiveCharacter(nextCharacter);
```

これにより、将来GameManagerの内部実装が変わっても、RuntimeCharacterSwitcherは影響を受けません。

## 使用方法

### シーンセットアップ

1. **GameManager**: 従来通り配置（必須）
2. **PlayableCharacterRepository**: キャラクター一覧を管理（必須）
3. **RuntimeCharacterSwitcher**: キャラクター切り替え機能が必要な場合のみ配置（任意）

### RuntimeCharacterSwitcherの設定

ヒエラルキーに空のGameObjectを作成し、RuntimeCharacterSwitcherコンポーネントをアタッチします：

```
Hierarchy:
  - GameManager (GameManager component)
  - CharacterRepository (PlayableCharacterRepository component)
  - CharacterSwitcher (RuntimeCharacterSwitcher component) ← 新規
    - Switch Character Key: Tab (設定可能)
    - Enable Verbose Log: false
```

GameManagerとPlayableCharacterRepositoryは自動検出されるため、手動設定は不要です。

### UIボタンからの切り替え

RuntimeCharacterSwitcherの公開メソッドをUIボタンから呼び出せます：

```csharp
// UI Button の OnClick イベント
RuntimeCharacterSwitcher.SwitchToNextCharacter();
RuntimeCharacterSwitcher.SwitchToPreviousCharacter();
```

## テスト結果

診断ツールで確認した結果、コンパイルエラーはなく、Hintレベルの最適化提案のみでした。

## コードサイズの変化

- **GameManager.cs**: 522行 → 456行（約13%削減）
- **新規追加**: RuntimeCharacterSwitcher.cs（約240行）

GameManagerがよりシンプルになり、キャラクター切り替え機能は独立したコンポーネントとして再利用可能になりました。

## 今後の拡張例

RuntimeCharacterSwitcherを基盤として、以下の機能を追加できます：

1. **ホイールスクロールでの切り替え**: マウスホイールの入力を検出
2. **数字キーでのダイレクト切り替え**: 1キーで1番目、2キーで2番目のキャラクターに切り替え
3. **お気に入りキャラクターへの切り替え**: 特定のキーで登録したお気に入りキャラクターに瞬時に切り替え
4. **キャラクター選択UI**: グリッド表示でキャラクターを選択
5. **ランダム切り替え**: ランダムにキャラクターを選択

これらの機能を追加する際、GameManagerやPlayableCharacterRepositoryを変更する必要はありません。

## 備考

- GameManagerの行数が削減され、より管理しやすくなりました
- 従来の機能は完全に保持されており、使用感は変わりません
- RuntimeCharacterSwitcherは完全にオプショナルであり、不要なシーンでは配置しなくても問題ありません
- GameManager.SetActiveCharacter()がpublicであるため、他のシステムからも自由にアクティブキャラクターを変更できます
