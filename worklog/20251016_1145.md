# 作業レポート 2025-10-16 11:45

## 変更内容の概要

- GameInputManager.csのUpdateAnimator()メソッドにAnimatorController存在チェックを追加しました
- "Animator is not playing an AnimatorController"警告を抑制しました
- AnimatorControllerが割り当てられていない場合、パラメータ設定をスキップするように修正しました

## 変更理由

Unity実行時に以下の警告が発生していました：

```
Animator is not playing an AnimatorController
UnityEngine.Animator:SetFloat (string,single)
GameInputManager:UpdateAnimator () (at Assets/Scripts/GameManager/GameInputManager.cs:440)
```

この警告は、Animatorコンポーネントは存在するものの、AnimatorControllerが割り当てられていない状態でパラメータ設定を試みたために発生していました。

VRM読み込み機能の整理により、起動時にAnimatorControllerが未割り当てのキャラクターが存在する可能性があるため、適切なガードチェックが必要でした。

## 変更したファイル

### 変更: Assets/Scripts/GameManager/GameInputManager.cs

**更新したUpdateAnimator() (436-444行目):**

```csharp
void UpdateAnimator()
{
    if (animator != null && animator.runtimeAnimatorController != null && animator.isInitialized)
    {
        animator.SetFloat("Speed", playerSpeed);
        animator.SetBool("inAir", !IsGrounded());
        animator.SetBool("isCrouched", isCrouched);
    }
}
```

**変更点:**
- **変更前**: `if (animator != null)`
- **変更後**: `if (animator != null && animator.runtimeAnimatorController != null && animator.isInitialized)`

**チェックの追加理由:**
1. **Animatorコンポーネントの存在確認**: `animator != null`
2. **AnimatorControllerの割り当て確認**: `animator.runtimeAnimatorController != null`
3. **Animatorの初期化完了確認**: `animator.isInitialized`

これにより、AnimatorControllerが未割り当ての場合、または初期化が完了していない場合でもパラメータ設定をスキップし、警告を発生させなくなりました。

**追加修正 (ユーザーフィードバック後):**

最初の修正では`runtimeAnimatorController != null`のチェックのみを追加しましたが、警告が継続して発生していました。原因は、AnimatorControllerが割り当てられていても、Animatorの初期化が完了していない状態でパラメータ設定を試みていたためです。

`animator.isInitialized`のチェックを追加することで、Animatorが完全に初期化されるまでパラメータ設定を待機するようにしました。これはUnityのAnimatorコンポーネントの標準プロパティで、初期化の完了状態を正確に判定できます。

## 技術的な背景

### Animatorコンポーネントの構造

Unityの`Animator`コンポーネントは3つの状態を持ちます：

1. **コンポーネント自体が存在するか**: GameObject.GetComponent<Animator>()の結果
2. **AnimatorControllerが割り当てられているか**: animator.runtimeAnimatorController != null
3. **初期化が完了しているか**: animator.isInitialized

AnimatorコンポーネントはGameObjectにアタッチされていても、以下の場合にパラメータ（Speed、inAir、isCrouchedなど）を設定しようとすると警告が発生します：
- AnimatorControllerが割り当てられていない場合
- AnimatorControllerは割り当てられているが、初期化が完了していない場合（フレーム遅延など）

### VRM読み込みとAnimatorController

VRM読み込み時の処理フロー：

```
1. VRMUtility.LoadAndSetupVrmFromPath()
   - VRMファイルを読み込んでGameObjectを生成
   - Animatorコンポーネントをアタッチ

2. VRMUtility.SetupCharacterComponents()
   - RuntimeAnimatorControllerを設定（vrmAnimatorControllerが指定されている場合）
   - Rigidbody、Colliderなどを設定
```

PlayableCharacterRepository.LoadStartupVrmCharacter()では、`vrmAnimatorController`フィールドにAnimatorControllerが設定されている場合のみVRMUtility.LoadAndSetupVrmFromPath()に渡されます。

未設定の場合、VRMキャラクターのAnimatorコンポーネントには`runtimeAnimatorController`が割り当てられていない状態になります。

### 他のコンポーネントでも同様のチェックを実施

このパターンは他のコンポーネントでも実施されています：

**例: VRMUtility.cs (SetupCharacterComponents内)**
```csharp
if (animator != null && animatorController != null)
{
    animator.runtimeAnimatorController = animatorController;
}
```

GameInputManager.UpdateAnimator()でも同様のガードを追加することで、一貫性のある安全な実装になりました。

## テスト結果

診断ツールで確認した結果、コンパイルエラーはなく、Hintレベルの最適化提案のみでした。

## 一連のリファクタリングでの位置づけ

今回の修正は、以下の一連のリファクタリングの最終調整に相当します：

1. **20251016_0113**: VRM処理をVRMUtilityに移譲（670行 → 491行）
2. **20251016_0136**: キャラクター管理をPlayableCharacterRepositoryに分離（491行 → 522行）
3. **20251016_0145**: キャラクター切り替えをRuntimeCharacterSwitcherに分離（522行 → 456行）
4. **20251016_0150**: VRM読み込みをVRMLoadManagerに分離（456行 → 167行）
5. **20251016_0207**: 起動時VRM読み込みをPlayableCharacterRepositoryに移動
6. **20251016_1145**: Animator警告の抑制（今回の作業）

GameManagerの大規模リファクタリングにより、VRM読み込み機能が複数のコンポーネントに分散されました。それに伴い、AnimatorControllerが未割り当てのキャラクターが存在する可能性が出てきたため、適切なガードチェックが必要になりました。

## 備考

- AnimatorControllerが未割り当て、または初期化未完了のキャラクターでも警告なしに動作するようになりました
- `animator.isInitialized`のチェックにより、初期化タイミングの問題を完全に解決しました
- UpdateAnimator()のガードチェックは一般的なベストプラクティスに準拠しています
- VRMUtility.csでの類似チェックと一貫性のある実装になりました
- AnimatorControllerを後から動的に設定する拡張にも対応できます
- 初期化が完了するまでパラメータ設定を自動的に待機するため、フレーム遅延による問題も発生しません
