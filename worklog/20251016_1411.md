# 作業レポート 2025-10-16 14:11

## 変更内容の概要

- GameSoundManagerに警告サウンド用AudioSourceを追加しました
- IsCautionを購読して警告サウンドのループ再生/停止を実装しました
- IsCaution解除時に自動的にアラームサウンドを停止するようにしました

## 変更理由

残りHPが1の時に警告音を鳴らすことで、プレイヤーに危険な状態を聴覚的にフィードバックする必要がありました。

警告サウンド専用のAudioSource（cautionAudioSource）を追加し、loop=trueに設定することで、警告状態中は継続的に音が鳴り続けるようにしました。

UserDataManager.Data.IsCautionを購読することで、HP警告状態の開始/終了を自動的に検知し、警告サウンドの再生/停止を制御します。

## 変更したファイル

### 変更: Assets/Sounds/GameSoundManager.cs

**追加したフィールド (34, 38行目):**

```csharp
private AudioSource cautionAudioSource;

private IDisposable cautionSubscription;
```

**設計の特徴:**
- **cautionAudioSource**: 警告サウンド専用のAudioSource（loop=true）
- **cautionSubscription**: IsCaution購読のDisposable

**更新したAwake() (62-65行目):**

```csharp
// 警告サウンド用AudioSource
cautionAudioSource = this.AddComponent<AudioSource>();
cautionAudioSource.loop = true;
cautionAudioSource.volume = sfxVolume * masterVolume;
```

**AudioSourceの設定:**
- **loop = true**: ループ再生有効
- **volume**: sfxVolume * masterVolume（SFXと同じ音量設定）

**追加したIsCaution購読 (76-87行目):**

```csharp
// HP警告状態を購読
cautionSubscription = UserDataManager.Data.IsCaution.Subscribe(isCaution =>
{
    if (isCaution)
    {
        PlayCautionSound();
    }
    else
    {
        StopCautionSound();
    }
});
```

**処理の流れ:**
1. **IsCaution = true**: PlayCautionSound()を呼び出し、警告サウンドのループ再生を開始
2. **IsCaution = false**: StopCautionSound()を呼び出し、警告サウンドを停止

**追加したPlayCautionSound() (101-111行目):**

```csharp
/// <summary>
/// 警告サウンドをループ再生
/// </summary>
private void PlayCautionSound()
{
    if (cautionSound != null && cautionAudioSource != null)
    {
        cautionAudioSource.clip = cautionSound;
        cautionAudioSource.Play();
    }
}
```

**処理の流れ:**
1. **cautionSoundとcautionAudioSourceの存在確認**
2. **clip設定**: cautionAudioSource.clip = cautionSound
3. **再生開始**: cautionAudioSource.Play()
   - loop=trueなので、clipが終了したら自動的に最初から再生される

**追加したStopCautionSound() (113-122行目):**

```csharp
/// <summary>
/// 警告サウンドを停止
/// </summary>
private void StopCautionSound()
{
    if (cautionAudioSource != null && cautionAudioSource.isPlaying)
    {
        cautionAudioSource.Stop();
    }
}
```

**処理の流れ:**
1. **cautionAudioSourceの存在確認**
2. **再生中チェック**: cautionAudioSource.isPlaying
3. **停止**: cautionAudioSource.Stop()

**更新したOnDestroy() (124-129行目):**

```csharp
private void OnDestroy()
{
    // R3購読の解放
    damageSubscription?.Dispose();
    cautionSubscription?.Dispose();
}
```

cautionSubscription?.Dispose()を追加し、メモリリークを防止します。

## アーキテクチャの設計

### データフローの全体像

```
1. プレイヤーがDamageSourceタグのオブジェクト（Spike）に衝突
   ↓
2. UserDataManager.TakeDamage()
   - CurrentHp.Value を減らす（例: 3 → 1）
   ↓
3. UserData.CurrentHp の変化を検知
   ↓
4. UserData.IsCaution が自動的に更新される
   - CurrentHp.Select(x => x <= 1 && x > 0)
   - HP = 1: IsCaution = true
   ↓
5. GameSoundManager.cautionSubscription がIsCautionの変化を受信
   ↓
6. GameSoundManager.PlayCautionSound()
   - cautionAudioSource.clip = cautionSound
   - cautionAudioSource.Play()
   - ループ再生開始
   ↓
7. HP回復または死亡
   - HP = 1 → 2: IsCaution = true → false
   - HP = 1 → 0: IsCaution = true → false
   ↓
8. GameSoundManager.StopCautionSound()
   - cautionAudioSource.Stop()
   - ループ再生停止
```

### 3つのAudioSourceの役割分担

**1. bgmAudioSource:**
- **用途**: BGM再生
- **loop**: true
- **volume**: musicVolume * masterVolume
- **再生方法**: Play()

**2. sfxAudioSource:**
- **用途**: 効果音再生（ダメージサウンドなど）
- **loop**: false
- **volume**: sfxVolume * masterVolume
- **再生方法**: PlayOneShot()

**3. cautionAudioSource（今回追加）:**
- **用途**: 警告サウンドのループ再生
- **loop**: true
- **volume**: sfxVolume * masterVolume
- **再生方法**: Play() / Stop()

### 警告サウンドの特徴

**ループ再生:**
- loop=trueにより、clipが終了したら自動的に最初から再生
- 警告状態が続く限り、音が鳴り続ける

**自動停止:**
- IsCaution = falseになると自動的にStop()
- HP回復時または死亡時に音が止まる

**PlayOneShot()を使用しない理由:**
- PlayOneShot()は一度きりの再生
- ループ再生には不向き
- Play()とStop()で明示的に制御

### IsCaution購読者（現在3つ）

**1. GamePostProcessManager:**
- 画面赤色点滅エフェクト

**2. GameUIManager:**
- （今回は追加していないが、将来的にHP表示の強調表示などに使用可能）

**3. GameSoundManager（今回追加）:**
- 警告サウンドのループ再生/停止

## 設計の利点

### 1. イベント駆動アーキテクチャ

**GameSoundManager ←→ UserDataManager:**
- 直接依存せず、R3のReadOnlyReactivePropertyを介して通信
- UserDataManagerの実装詳細をGameSoundManagerが知る必要がない

### 2. 自動的な再生/停止制御

**IsCautionの変化に応じて自動的に再生/停止:**
- HP = 3 → 1: 警告サウンド再生開始
- HP = 1 → 2: 警告サウンド停止
- HP = 1 → 0: 警告サウンド停止（死亡）
- 手動で再生/停止を管理する必要がない

### 3. AudioSourceの役割分担

**BGM、SFX、警告サウンドを独立管理:**
- BGMを止めずに警告サウンドを再生可能
- ダメージサウンド（PlayOneShot）と警告サウンド（ループ再生）を同時に鳴らせる
- それぞれ独立した音量調整が可能

### 4. メモリ管理

**OnDestroy()で購読を解放:**
- damageSubscription?.Dispose()
- cautionSubscription?.Dispose()
- メモリリーク防止

### 5. 拡張性の高い設計

**新しい警告音の追加が容易:**
```csharp
// 例: HP≦2で別の警告音
var warningSubscription = UserDataManager.Data.IsWarning.Subscribe(isWarning =>
{
    if (isWarning)
    {
        PlayWarningSound();
    }
    else
    {
        StopWarningSound();
    }
});
```

### 6. Play() / Stop()による明示的な制御

**ループ再生の明確な開始/停止:**
- Play()で再生開始
- Stop()で再生停止
- isPlayingで再生状態を確認可能

## テスト結果

診断ツールで確認した結果、コンパイルエラーはなく、Hintレベルの最適化提案のみでした。

## 備考

- GameSoundManagerに警告サウンド専用のAudioSource（cautionAudioSource）を追加しました
- loop=trueに設定し、警告状態中は継続的に音が鳴り続けます
- UserDataManager.Data.IsCautionを購読し、警告状態の開始/終了を自動検知します
- IsCaution = trueで警告サウンドのループ再生を開始します
- IsCaution = falseで警告サウンドを停止します
- OnDestroy()でR3購読を解放し、メモリリークを防止しています
- Inspector から cautionSound に AudioClip を設定する必要があります
- 音量はsfxVolume * masterVolumeで設定されます（BGMとは独立）
- BGM、SFX、警告サウンドの3つのAudioSourceを独立して管理しています
- ダメージシステム全体がイベント駆動アーキテクチャで設計されており、新しい購読者を容易に追加可能です
