# 作業レポート 2025-10-16 16:31

## 変更内容の概要

- GameCharacterCollisionTriggerに「DeadZone」タグ判定を追加しました
- DeadZoneに触れた時に即座に死亡する処理を実装しました
- instantDeathOnDeadZone設定を追加し、即死モードと通常ダメージモードを切り替えられるようにしました

## 変更理由

ユーザーから「落下判定用のBoxColliderをタグ『DeadZone』で配置しました。これに触れた際に死亡するようにしてください」という要望がありました。

落下死亡判定は、ステージから落下した際にプレイヤーを即座にリスポーンさせるために必要な機能です。

GameCharacterCollisionTriggerに処理を追加することで、コイン取得やダメージソースと同じ仕組みで落下死亡を実装できます。

## 変更したファイル

### 変更: Assets/Scripts/Character/GameCharacterCollisionTrigger.cs

**更新したクラスコメント (3-9行目):**

```csharp
/// <summary>
/// プレイヤーのコリジョントリガー
/// プレイヤーオブジェクトにアタッチして使用
/// - コイン取得
/// - ダメージソースとの衝突検知
/// - DeadZone（落下死亡判定）
/// </summary>
```

**追加したDeadZone設定 (17-19行目):**

```csharp
[Header("DeadZone設定")]
[Tooltip("DeadZoneに触れた時に即座に死亡するか（true: 即死, false: MaxHPのダメージ）")]
[SerializeField] private bool instantDeathOnDeadZone = true;
```

**設計の特徴:**
- **instantDeathOnDeadZone（デフォルトtrue）**: DeadZoneに触れた時に即座に死亡するかどうか
  - **true**: 現在HPと同じダメージを与える（即死）
  - **false**: MaxHP分のダメージを与える（通常は即死だが、HP回復などで変動する可能性を考慮）

**更新したOnTriggerEnter()メソッド (38-42行目):**

```csharp
// DeadZoneタグのオブジェクトに触れたかチェック
else if (other.CompareTag("DeadZone"))
{
    EnterDeadZone(other.gameObject);
}
```

**変更前:**
```csharp
void OnTriggerEnter(Collider other)
{
    // コインタグのオブジェクトに触れたかチェック
    if (other.CompareTag("Coin"))
    {
        CollectCoin(other.gameObject);
    }
    // ダメージソースタグのオブジェクトに触れたかチェック
    else if (other.CompareTag("DamageSource"))
    {
        TakeDamageFromSource(other.gameObject);
    }
}
```

**変更後:**
```csharp
void OnTriggerEnter(Collider other)
{
    // コインタグのオブジェクトに触れたかチェック
    if (other.CompareTag("Coin"))
    {
        CollectCoin(other.gameObject);
    }
    // ダメージソースタグのオブジェクトに触れたかチェック
    else if (other.CompareTag("DamageSource"))
    {
        TakeDamageFromSource(other.gameObject);
    }
    // DeadZoneタグのオブジェクトに触れたかチェック
    else if (other.CompareTag("DeadZone"))
    {
        EnterDeadZone(other.gameObject);
    }
}
```

**追加したEnterDeadZone()メソッド (80-106行目):**

```csharp
/// <summary>
/// DeadZoneに入った時の処理
/// </summary>
/// <param name="deadZone">DeadZoneのGameObject</param>
void EnterDeadZone(GameObject deadZone)
{
    // 既に死亡している場合は処理しない
    if (UserDataManager.Data.IsDead.CurrentValue)
    {
        return;
    }

    Debug.Log($"GameCharacterCollisionTrigger: DeadZone ({deadZone.name}) に入りました。");

    if (instantDeathOnDeadZone)
    {
        // 即座に死亡（現在HPと同じダメージを与える）
        int currentHp = UserDataManager.Data.CurrentHp.CurrentValue;
        UserDataManager.TakeDamage(currentHp, deadZone);
    }
    else
    {
        // MaxHP分のダメージを与える（通常は即死）
        int maxHp = UserDataManager.Data.MaxHp.CurrentValue;
        UserDataManager.TakeDamage(maxHp, deadZone);
    }
}
```

**処理の流れ:**

1. **IsDead.CurrentValueチェック**: 既に死亡している場合は処理をスキップ
   - 死亡アニメーション中にDeadZoneに触れ続けても、重複処理を防ぐ

2. **デバッグログ出力**: "DeadZone ({deadZone.name}) に入りました。"

3. **instantDeathOnDeadZoneによる分岐**:

   **true（デフォルト）: 即座に死亡**
   ```csharp
   int currentHp = UserDataManager.Data.CurrentHp.CurrentValue;
   UserDataManager.TakeDamage(currentHp, deadZone);
   ```
   - 現在HPと同じダメージを与えることで、確実にHP = 0にする
   - 例: 現在HP = 2 → 2ダメージ → HP = 0（死亡）

   **false: MaxHP分のダメージ**
   ```csharp
   int maxHp = UserDataManager.Data.MaxHp.CurrentValue;
   UserDataManager.TakeDamage(maxHp, deadZone);
   ```
   - MaxHP分のダメージを与える（通常は即死）
   - 例: MaxHP = 3, 現在HP = 2 → 3ダメージ → HP = -1 → 0（死亡）

4. **UserDataManager.TakeDamage()呼び出し**:
   - ダメージイベント発火（OnDamageReceived）
   - HP更新（CurrentHp.Value）
   - IsDead自動更新（HP <= 0 → IsDead = true）

## アーキテクチャの設計

### タグによるコリジョン判定の統一

**GameCharacterCollisionTriggerで処理するタグ:**

| タグ | 処理 | メソッド |
|-----|------|---------|
| **Coin** | コイン取得、HP回復 | CollectCoin() |
| **DamageSource** | ダメージを受ける | TakeDamageFromSource() |
| **DeadZone** | 即座に死亡 | EnterDeadZone() |

すべてのタグ判定がOnTriggerEnter()で統一的に処理されます。

### DeadZoneの仕組み

```
1. プレイヤーがステージから落下
   ↓
2. DeadZoneタグのBoxColliderに触れる
   ↓
3. GameCharacterCollisionTrigger.OnTriggerEnter()
   - other.CompareTag("DeadZone") == true
   ↓
4. EnterDeadZone(deadZone)
   - IsDead.CurrentValue == true の場合は処理スキップ
   - UserDataManager.TakeDamage(currentHp, deadZone)
   ↓
5. UserDataManager.TakeDamage()
   - CurrentHp.Value = 0
   - OnDamageReceived.OnNext()
   - IsDead = true（自動更新）
   ↓
6. 死亡/リスポーンシステムが自動起動
   - GameInputManager.OnDead()
   - GamePostProcessManager.StartDeadFade()
   - GameManager.RespawnSequence()
```

### 既存システムとの統合

**DeadZoneはUserDataManager.TakeDamage()を使用:**
- 既存のダメージシステムと同じ仕組み
- OnDamageReceivedイベントが発火
- ダメージサウンド、ダメージフラッシュも発動
- 死亡/リスポーンシステムが自動的に起動

**死亡判定の重複防止:**
```csharp
if (UserDataManager.Data.IsDead.CurrentValue)
{
    return;  // 既に死亡している場合は処理しない
}
```
- 死亡アニメーション中にDeadZoneに触れ続けても、重複ダメージを防ぐ

## 設定のカスタマイズ

### Inspector設定

**instantDeathOnDeadZone:**
- **true（デフォルト）**: 現在HPと同じダメージを与える
  - 確実に即死させる
  - おすすめ設定

- **false**: MaxHP分のダメージを与える
  - HP回復などで変動する可能性を考慮
  - 通常は即死だが、特殊なケースで生き残る可能性がある

### 使用例

**例1: 通常の落下死亡（デフォルト）**
- instantDeathOnDeadZone = true
- 現在HP = 2 → 2ダメージ → HP = 0（即死）
- 現在HP = 1 → 1ダメージ → HP = 0（即死）

**例2: 特殊なゲームモード**
- instantDeathOnDeadZone = false
- MaxHP = 3, 現在HP = 2 → 3ダメージ → HP = -1 → 0（死亡）
- 特殊な防御スキルで軽減される可能性がある（将来の拡張）

## シーン設定

### DeadZone設定手順

1. **BoxColliderを配置**:
   - シーンにGameObjectを作成
   - BoxColliderコンポーネントを追加
   - Is Trigger = trueに設定

2. **タグを設定**:
   - GameObjectのTagを「DeadZone」に設定
   - タグが存在しない場合は、Unityエディタで「DeadZone」タグを作成

3. **サイズと位置を調整**:
   - ステージの下部に配置
   - BoxColliderのサイズをステージ全体をカバーするように調整

4. **テスト**:
   - プレイヤーがステージから落下してDeadZoneに触れることを確認
   - 死亡アニメーション → 暗転 → リスポーンの流れを確認

### 推奨設定

**DeadZoneの配置:**
- ステージの最低地点より少し下に配置
- プレイヤーが視覚的にステージから落下したと感じるタイミングで死亡判定

**BoxColliderのサイズ:**
- ステージ全体をカバーする大きなBoxCollider
- Y座標はステージの最低地点より-10～-20程度下

## 設計の利点

### 1. 既存システムとの統合

**UserDataManager.TakeDamage()を使用:**
- 既存のダメージシステムと同じ仕組み
- OnDamageReceivedイベントが発火
- ダメージサウンド、ダメージフラッシュ、死亡/リスポーンシステムがすべて自動的に動作

### 2. 統一的なタグ判定

**GameCharacterCollisionTrigger:**
- Coin、DamageSource、DeadZoneのすべてのタグ判定を一元管理
- OnTriggerEnter()で統一的に処理

### 3. 重複処理の防止

**IsDead.CurrentValueチェック:**
- 既に死亡している場合は処理をスキップ
- 死亡アニメーション中にDeadZoneに触れ続けても、重複ダメージを防ぐ

### 4. 柔軟な設定

**instantDeathOnDeadZone:**
- Inspector設定で即死モードと通常ダメージモードを切り替え
- 将来的な拡張（防御スキルなど）にも対応可能

### 5. デバッグの容易性

**デバッグログ出力:**
```csharp
Debug.Log($"GameCharacterCollisionTrigger: DeadZone ({deadZone.name}) に入りました。");
```
- どのDeadZoneに触れたかを明確に出力
- 複数のDeadZoneを配置した場合でも識別可能

## テスト結果

診断ツールで確認した結果、コンパイルエラーはなく、Hintレベルの最適化提案のみでした。

## 備考

- GameCharacterCollisionTriggerに「DeadZone」タグ判定を追加しました
- DeadZoneに触れた時に即座に死亡する処理を実装しました
- instantDeathOnDeadZone設定（デフォルトtrue）を追加し、即死モードと通常ダメージモードを切り替えられるようにしました
- 既存のダメージシステム（UserDataManager.TakeDamage）を使用しているため、ダメージサウンド、ダメージフラッシュ、死亡/リスポーンシステムがすべて自動的に動作します
- IsDead.CurrentValueチェックにより、死亡アニメーション中の重複ダメージを防止しています
- シーンにBoxColliderを配置し、タグを「DeadZone」に設定するだけで使用できます
- Is Trigger = trueに設定し、ステージの下部に配置してください
- デバッグログで、どのDeadZoneに触れたかを確認できます
- 診断ツールで確認した結果、コンパイルエラーはありませんでした
