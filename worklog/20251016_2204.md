# 作業レポート 2025-10-16 22:04

## 変更内容の概要

- PingPongLoopモード時に、戻る際のイージングを制御するフラグを追加しました
- `invertEasingWhenPingPongBack`フラグ（デフォルト: false）を実装しました
- フラグがOFFの場合、戻る際のイージングが順方向と同じ動作になります

## 変更理由

ユーザーから「PingPongLoopの時のEase In / Ease Outですが、戻る際のイージングが逆になっており、設置時の直感に反する挙動でした。『Invert Easing when Ping-Pong back』フラグを用意して、有効な時は現在の実装のままとしてください。デフォルトはオフです。外した際は、戻りの移動が指定したイージングとなるように挙動を変更してください。」という指示がありました。

### 問題の詳細

**現在の実装（問題のある動作）:**

PingPongLoopモード + EaseInの場合：
- **順方向（0→1）**: 最初は遅く、徐々に加速（EaseIn）
- **逆方向（1→0）**: 最初は速く、徐々に減速（EaseOut的な動作）

これは、`t`が1.0→0.0に変化する際に、EaseIn関数（t²）を適用すると以下のようになるためです：

```
順方向: t = 0.0 → easedT = 0.0² = 0.0
        t = 0.5 → easedT = 0.5² = 0.25
        t = 1.0 → easedT = 1.0² = 1.0

逆方向: t = 1.0 → easedT = 1.0² = 1.0
        t = 0.5 → easedT = 0.5² = 0.25
        t = 0.0 → easedT = 0.0² = 0.0
```

逆方向では、`t`が1.0から0.5に減少する際に、`easedT`も1.0から0.25に急激に減少します。これはEaseOutのような動作になります。

### 期待される動作

**フラグOFF（デフォルト）:**

PingPongLoopモード + EaseInの場合：
- **順方向（0→1）**: 最初は遅く、徐々に加速（EaseIn）
- **逆方向（1→0）**: 最初は遅く、徐々に加速（EaseIn）← 同じイージング

**フラグON:**

PingPongLoopモード + EaseInの場合：
- **順方向（0→1）**: 最初は遅く、徐々に加速（EaseIn）
- **逆方向（1→0）**: 最初は速く、徐々に減速（EaseOut的）← 現在の実装

## 変更したファイル

### 変更: Assets/Scripts/Utilities/MovingCurve.cs

**invertEasingWhenPingPongBackフラグの追加 (56-57行目):**

```csharp
[Tooltip("PingPongLoop時、戻る際にイージングを反転するか")]
[SerializeField] private bool invertEasingWhenPingPongBack = false;
```

PingPongLoopモード時に、戻る際のイージング動作を制御するフラグを追加しました。デフォルトはfalseです。

**UpdatePosition()メソッドの更新 (228-241行目):**

```csharp
/// <summary>
/// パス上の位置（0.0～1.0）に基づいて、実際の位置を更新
/// </summary>
/// <param name="t">パス上の位置（0.0～1.0）</param>
void UpdatePosition(float t)
{
    // イージングを適用
    float easedT = ApplyEasingWithDirection(t, easingType);

    // 線形補間で位置を計算
    Vector3 newPosition = GetPositionOnPath(easedT);

    // ターゲットの位置を更新
    if (targetTransform != null)
    {
        targetTransform.position = newPosition;
    }
}
```

**変更前:**
```csharp
void UpdatePosition(float t)
{
    // イージングを適用
    float easedT = ApplyEasing(t, easingType);

    // 線形補間で位置を計算
    Vector3 newPosition = GetPositionOnPath(easedT);

    // ターゲットの位置を更新
    if (targetTransform != null)
    {
        targetTransform.position = newPosition;
    }
}
```

**変更後:**
`ApplyEasing()`の代わりに`ApplyEasingWithDirection()`を呼び出すようにしました。

**ApplyEasingWithDirection()メソッドの追加 (291-321行目):**

```csharp
/// <summary>
/// イージングを適用（方向を考慮）
/// </summary>
/// <param name="t">パス上の位置（0.0～1.0）</param>
/// <param name="type">イージングタイプ</param>
/// <returns>イージング適用後の位置</returns>
float ApplyEasingWithDirection(float t, EasingType type)
{
    // PingPongLoopモードで逆方向の場合
    if (loopMode == LoopMode.PingPongLoop && direction == -1)
    {
        if (invertEasingWhenPingPongBack)
        {
            // 反転フラグがON: イージングをそのまま適用（現在の実装）
            return ApplyEasing(t, type);
        }
        else
        {
            // 反転フラグがOFF: イージングを反転
            // t を 1-t に変換してイージング適用後、再度 1-t に変換
            float invertedT = 1f - t;
            float easedInvertedT = ApplyEasing(invertedT, type);
            return 1f - easedInvertedT;
        }
    }
    else
    {
        // 順方向、または他のモード: イージングをそのまま適用
        return ApplyEasing(t, type);
    }
}
```

新しく追加したメソッドです。PingPongLoopモードで逆方向（direction == -1）の場合に、フラグに応じてイージングを制御します。

**ApplyEasing()メソッド (323-357行目):**

変更なし。既存のイージング関数をそのまま使用します。

## アーキテクチャの設計

### イージング反転の仕組み

**フラグOFF（デフォルト）の場合:**

逆方向の移動時に、以下の変換を行います：

```
1. t を 1-t に変換（反転）
   ↓
2. イージング適用
   ↓
3. 結果を 1-result に変換（反転）
```

**例: EaseIn（t²）で逆方向の場合**

```
順方向:
  t = 0.0 → easedT = 0.0² = 0.0
  t = 0.5 → easedT = 0.5² = 0.25
  t = 1.0 → easedT = 1.0² = 1.0

逆方向（フラグOFF）:
  t = 1.0 → invertedT = 0.0 → easedInvertedT = 0.0² = 0.0 → easedT = 1.0 - 0.0 = 1.0
  t = 0.5 → invertedT = 0.5 → easedInvertedT = 0.5² = 0.25 → easedT = 1.0 - 0.25 = 0.75
  t = 0.0 → invertedT = 1.0 → easedInvertedT = 1.0² = 1.0 → easedT = 1.0 - 1.0 = 0.0
```

逆方向でも、`t`が減少する際に`easedT`が急激に減少するため、EaseInの動作（最初は遅く、徐々に加速）が再現されます。

**フラグON の場合:**

逆方向でもイージングをそのまま適用します（現在の実装と同じ）。

```
逆方向（フラグON）:
  t = 1.0 → easedT = 1.0² = 1.0
  t = 0.5 → easedT = 0.5² = 0.25
  t = 0.0 → easedT = 0.0² = 0.0
```

### 各イージングタイプの動作

#### EaseIn（加速）

**フラグOFF（デフォルト）:**
- 順方向: 最初は遅く、徐々に加速
- 逆方向: 最初は遅く、徐々に加速（同じ）

**フラグON:**
- 順方向: 最初は遅く、徐々に加速
- 逆方向: 最初は速く、徐々に減速

#### EaseOut（減速）

**フラグOFF（デフォルト）:**
- 順方向: 最初は速く、徐々に減速
- 逆方向: 最初は速く、徐々に減速（同じ）

**フラグON:**
- 順方向: 最初は速く、徐々に減速
- 逆方向: 最初は遅く、徐々に加速

#### EaseInOut（加速→減速）

**フラグOFF（デフォルト）:**
- 順方向: 最初は加速、後半は減速
- 逆方向: 最初は加速、後半は減速（同じ）

**フラグON:**
- 順方向: 最初は加速、後半は減速
- 逆方向: 最初は減速、後半は加速（逆）

### 数式による説明

**EaseIn（t²）の場合:**

**順方向（direction = 1）:**
```
easedT = t²
```

**逆方向（direction = -1）、フラグOFF:**
```
invertedT = 1 - t
easedInvertedT = (1 - t)²
easedT = 1 - (1 - t)²
```

これは、EaseOutの式と同じです。しかし、`t`が1.0→0.0に減少するため、結果として以下のようになります：

```
t = 1.0: easedT = 1 - (1 - 1)² = 1 - 0 = 1.0
t = 0.75: easedT = 1 - (1 - 0.75)² = 1 - 0.0625 = 0.9375
t = 0.5: easedT = 1 - (1 - 0.5)² = 1 - 0.25 = 0.75
t = 0.25: easedT = 1 - (1 - 0.25)² = 1 - 0.5625 = 0.4375
t = 0.0: easedT = 1 - (1 - 0)² = 1 - 1 = 0.0
```

`t`が1.0から0.75に減少する際、`easedT`は1.0から0.9375にわずかしか減少しません（最初は遅い）。
`t`が0.25から0.0に減少する際、`easedT`は0.4375から0.0に大きく減少します（後半は速い）。

これは、逆方向でもEaseInの動作（最初は遅く、徐々に加速）が再現されることを意味します。

**逆方向（direction = -1）、フラグON:**
```
easedT = t²
```

```
t = 1.0: easedT = 1.0² = 1.0
t = 0.75: easedT = 0.75² = 0.5625
t = 0.5: easedT = 0.5² = 0.25
t = 0.25: easedT = 0.25² = 0.0625
t = 0.0: easedT = 0.0² = 0.0
```

`t`が1.0から0.75に減少する際、`easedT`は1.0から0.5625に大きく減少します（最初は速い）。
`t`が0.25から0.0に減少する際、`easedT`は0.0625から0.0にわずかしか減少しません（後半は遅い）。

これは、EaseOutの動作（最初は速く、徐々に減速）になります。

## 使用例

### 例1: 往復プラットフォーム（EaseIn + フラグOFF）

```
設定:
  Loop Mode: PingPong Loop
  Easing Type: Ease In
  Invert Easing When Ping-Pong Back: false（デフォルト）
  Wait Time At End: 1.0
```

**動作:**
- Point 0 → Point 1: 最初は遅く、徐々に加速
- 1秒待機
- Point 1 → Point 0: 最初は遅く、徐々に加速（同じ）
- 1秒待機
- 繰り返し

**用途:**
- 往復するプラットフォームで、両方向とも同じイージングで動かしたい場合

### 例2: 往復プラットフォーム（EaseIn + フラグON）

```
設定:
  Loop Mode: PingPong Loop
  Easing Type: Ease In
  Invert Easing When Ping-Pong Back: true
  Wait Time At End: 1.0
```

**動作:**
- Point 0 → Point 1: 最初は遅く、徐々に加速（EaseIn）
- 1秒待機
- Point 1 → Point 0: 最初は速く、徐々に減速（EaseOut的）
- 1秒待機
- 繰り返し

**用途:**
- 往復するプラットフォームで、行きと帰りで異なるイージングを適用したい場合

### 例3: 往復プラットフォーム（EaseInOut + フラグOFF）

```
設定:
  Loop Mode: PingPong Loop
  Easing Type: Ease InOut
  Invert Easing When Ping-Pong Back: false（デフォルト）
  Wait Time At End: 1.0
```

**動作:**
- Point 0 → Point 1: 最初は加速、後半は減速
- 1秒待機
- Point 1 → Point 0: 最初は加速、後半は減速（同じ）
- 1秒待機
- 繰り返し

**用途:**
- 滑らかな往復動作が必要な場合（最も一般的）

## 動作確認

### 期待される動作:

**フラグOFF（デフォルト）:**
- PingPongLoopモード時、戻る際のイージングが順方向と同じになる
- EaseInの場合、往復ともに「最初は遅く、徐々に加速」

**フラグON:**
- PingPongLoopモード時、戻る際のイージングが反転する
- EaseInの場合、順方向は「最初は遅く、徐々に加速」、逆方向は「最初は速く、徐々に減速」

### テスト手順:

1. Unity Editorでシーンを開く
2. GameObjectを作成（例: MovingPlatform）
3. MovingCurveコンポーネントをアタッチ
4. 以下を設定:
   - Loop Mode: PingPong Loop
   - Easing Type: Ease In
   - Invert Easing When Ping-Pong Back: false
   - Wait Time At End: 1.0
   - Move Speed: 2.0
   - Path Points: 2つ（始点と終点）
5. ゲームを実行して、往復ともに「最初は遅く、徐々に加速」することを確認
6. Invert Easing When Ping-Pong Back を true に変更
7. ゲームを実行して、順方向は「最初は遅く、徐々に加速」、逆方向は「最初は速く、徐々に減速」することを確認

## 備考

- PingPongLoopモード時に、戻る際のイージングを制御するフラグを追加しました
- `invertEasingWhenPingPongBack`フラグ（デフォルト: false）を実装しました
- フラグがOFFの場合、逆方向でも順方向と同じイージング動作になります
- フラグがONの場合、逆方向でイージングが反転します（以前の実装と同じ）
- ApplyEasingWithDirection()メソッドを追加し、方向を考慮したイージング適用を実装しました
- UpdatePosition()メソッドを更新し、ApplyEasingWithDirection()を呼び出すようにしました
- 診断ツールで確認した結果、コンパイルエラーはありませんでした
- コード行数: 437行 → 472行（35行増加、約8%増加）
