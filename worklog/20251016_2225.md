# 作業レポート 2025-10-16 22:25

## 変更内容の概要

- DefaultSpawnPointの設定をGameManagerに一元化しました
- PlayableCharacterRepositoryとVRMLoadManagerからGameManagerのDefaultSpawnPointを参照するように修正しました
- 設定が重複していた問題を解消しました

## 変更理由

ユーザーから「Default Spawn Pointの設定がGameManager、GameCharacterRepository、VrmLoadManagerに跨ってしまっています。全てGameManagerの設定値を参照する形に修正してください。」という指示がありました。

### 問題の詳細

DefaultSpawnPointの設定が以下の3つのコンポーネントに重複していました：

1. **GameManager.cs**: `defaultSpawnPoint`フィールド（リスポーン処理用）
2. **PlayableCharacterRepository.cs**: `defaultSpawnPoint`フィールド（VRM読み込み時のスポーン位置）
3. **VRMLoadManager.cs**: `defaultSpawnPoint`フィールド（VRM読み込み時のスポーン位置）

これにより、以下の問題が発生していました：

- **設定の重複**: 同じ内容を3箇所で設定する必要がある
- **不整合のリスク**: 3箇所の設定が異なる値になる可能性がある
- **保守性の低下**: DefaultSpawnPointを変更する際に3箇所を更新する必要がある

### 解決策

GameManagerをDefaultSpawnPointの唯一の情報源（Single Source of Truth）とし、他のコンポーネントはGameManagerから参照する形に変更しました。

## 変更したファイル

### 変更: Assets/Scripts/GameManager/GameManager.cs

**DefaultSpawnPointプロパティの追加 (59-60行目):**

```csharp
/// <summary>DefaultSpawnPointへのアクセスプロパティ（他のコンポーネントから参照可能）</summary>
public Transform DefaultSpawnPoint => defaultSpawnPoint;
```

**変更前:**
```csharp
[SerializeField] private Transform defaultSpawnPoint;
```

**変更後:**
publicプロパティを追加し、他のコンポーネントから`gameManager.DefaultSpawnPoint`でアクセスできるようにしました。

### 変更: Assets/Scripts/Character/PlayableCharacterRepository.cs

**フィールドの変更 (26-32行目):**

```csharp
[Header("VRM設定")]
[Tooltip("VRMキャラクターに適用するアニメーションコントローラー")]
[SerializeField] private RuntimeAnimatorController vrmAnimatorController;

[Header("GameManager参照")]
[Tooltip("GameManager（DefaultSpawnPoint参照用）")]
[SerializeField] private GameManager gameManager;
```

**変更前:**
```csharp
[Header("VRM設定")]
[Tooltip("VRMキャラクターのデフォルトスポーン地点")]
[SerializeField] private Transform defaultSpawnPoint;

[Tooltip("VRMキャラクターに適用するアニメーションコントローラー")]
[SerializeField] private RuntimeAnimatorController vrmAnimatorController;
```

**変更後:**
- `defaultSpawnPoint`フィールドを削除
- `gameManager`フィールドを追加（GameManagerへの参照）

**スポーン位置取得の変更 (107-116行目):**

```csharp
// スポーン位置を決定（GameManagerから取得）
Vector3 spawnPosition = Vector3.zero;
if (gameManager != null && gameManager.DefaultSpawnPoint != null)
{
    spawnPosition = gameManager.DefaultSpawnPoint.position;
}
else
{
    Debug.LogWarning("PlayableCharacterRepository: GameManagerまたはDefaultSpawnPointが設定されていません。");
}
```

**変更前:**
```csharp
// スポーン位置を決定
Vector3 spawnPosition = defaultSpawnPoint != null ? defaultSpawnPoint.position : Vector3.zero;
```

**変更後:**
GameManagerからDefaultSpawnPointを取得するように変更しました。

### 変更: Assets/Scripts/Utilities/VRMLoadManager.cs

**フィールドの削除 (27-29行目):**

```csharp
[Header("VRM設定")]
[Tooltip("VRMキャラクターに適用するアニメーションコントローラー")]
[SerializeField] private RuntimeAnimatorController vrmAnimatorController;
```

**変更前:**
```csharp
[Header("VRM設定")]
[Tooltip("VRMキャラクターのデフォルトスポーン地点")]
[SerializeField] private Transform defaultSpawnPoint;

[Tooltip("VRMキャラクターに適用するアニメーションコントローラー")]
[SerializeField] private RuntimeAnimatorController vrmAnimatorController;
```

**変更後:**
`defaultSpawnPoint`フィールドを削除しました。

**スポーン位置取得の変更（3箇所）:**

VRMLoadManager.cs内の3箇所で同様の変更を行いました：

```csharp
// スポーン位置を決定（GameManagerから取得）
Vector3 spawnPosition = Vector3.zero;
if (gameManager != null && gameManager.DefaultSpawnPoint != null)
{
    spawnPosition = gameManager.DefaultSpawnPoint.position;
}
else
{
    Debug.LogWarning("VRMLoadManager: GameManagerまたはDefaultSpawnPointが設定されていません。");
}
```

**変更前:**
```csharp
// スポーン位置を決定
Vector3 spawnPosition = defaultSpawnPoint != null ? defaultSpawnPoint.position : Vector3.zero;
```

**変更後:**
GameManagerからDefaultSpawnPointを取得するように変更しました。

## アーキテクチャの設計

### Single Source of Truthパターン

**修正前（問題のある設計）:**

```
GameManager
  ↓ defaultSpawnPoint (リスポーン用)

PlayableCharacterRepository
  ↓ defaultSpawnPoint (VRM読み込み用)

VRMLoadManager
  ↓ defaultSpawnPoint (VRM読み込み用)
```

3つのコンポーネントがそれぞれ独自のDefaultSpawnPointを持っていました。

**修正後（正しい設計）:**

```
GameManager
  ↓ defaultSpawnPoint (唯一の情報源)
  ↓ public DefaultSpawnPoint プロパティ

PlayableCharacterRepository
  ↓ gameManager.DefaultSpawnPoint を参照

VRMLoadManager
  ↓ gameManager.DefaultSpawnPoint を参照
```

GameManagerが唯一の情報源（Single Source of Truth）となり、他のコンポーネントはこれを参照します。

### 依存関係

**修正前:**
```
GameManager → defaultSpawnPoint (独立)
PlayableCharacterRepository → defaultSpawnPoint (独立)
VRMLoadManager → defaultSpawnPoint (独立)
```

各コンポーネントが独立してDefaultSpawnPointを持っていたため、依存関係がありませんでした。

**修正後:**
```
GameManager → defaultSpawnPoint (情報源)
                ↑
                |
PlayableCharacterRepository → gameManager (依存)
VRMLoadManager → gameManager (依存)
```

PlayableCharacterRepositoryとVRMLoadManagerはGameManagerに依存するようになりました。

### 設定の流れ

**Inspector設定:**

1. **GameManager**: DefaultSpawnPointを設定（シーン内のTransform）
2. **PlayableCharacterRepository**: GameManagerへの参照を設定
3. **VRMLoadManager**: （既にGameManagerへの参照を持っている）

**実行時:**

1. PlayableCharacterRepositoryまたはVRMLoadManagerがVRMを読み込む
2. `gameManager.DefaultSpawnPoint.position`でスポーン位置を取得
3. VRMUtility.LoadAndSetupVrmFromPath()にスポーン位置を渡す

## 利点

### 1. 設定の一元化

**修正前:**
- GameManager、PlayableCharacterRepository、VRMLoadManagerの3箇所で設定
- 3つの設定が一致しているか確認する必要がある

**修正後:**
- GameManagerの1箇所のみで設定
- 他のコンポーネントは自動的に同じ値を使用

### 2. 不整合の防止

**修正前:**
```
GameManager.defaultSpawnPoint = Point A
PlayableCharacterRepository.defaultSpawnPoint = Point B（間違い）
VRMLoadManager.defaultSpawnPoint = Point C（間違い）
```

設定ミスにより、リスポーン位置とVRM読み込み位置が異なる可能性がありました。

**修正後:**
```
GameManager.DefaultSpawnPoint = Point A
↓
PlayableCharacterRepository → Point A（自動）
VRMLoadManager → Point A（自動）
```

すべてのコンポーネントが同じ位置を使用することが保証されます。

### 3. 保守性の向上

**修正前:**
- DefaultSpawnPointを変更する際に3箇所を更新
- 更新漏れのリスク

**修正後:**
- GameManagerの1箇所を更新するだけ
- 他のコンポーネントは自動的に新しい値を使用

### 4. 責務の明確化

**修正前:**
- 各コンポーネントがDefaultSpawnPointを管理する責務を持つ
- 責務の重複

**修正後:**
- GameManagerがDefaultSpawnPointを管理する唯一の責務を持つ
- PlayableCharacterRepositoryとVRMLoadManagerはGameManagerから取得するだけ

## 使用例

### Inspector設定

**GameManager:**
```
[Header: リスポーン設定]
Default Spawn Point: DefaultSpawnPoint (Transform)
```

**PlayableCharacterRepository:**
```
[Header: GameManager参照]
Game Manager: GameManager (GameObject)
```

**VRMLoadManager:**
```
[Header: 参照]
Game Manager: GameManager (GameObject)
（既に設定済み）
```

### 実行時の動作

**リスポーン時（GameManager）:**
```csharp
// GameManager.RespawnSequence()
activeCharacter.transform.position = defaultSpawnPoint.position;
```

**VRM読み込み時（PlayableCharacterRepository）:**
```csharp
// PlayableCharacterRepository.LoadStartupVrmCharacter()
Vector3 spawnPosition = gameManager.DefaultSpawnPoint.position;
yield return VRMUtility.LoadAndSetupVrmFromPath(vrmPath, spawnPosition, ...);
```

**VRM読み込み時（VRMLoadManager）:**
```csharp
// VRMLoadManager.LoadVrmFromStreamingAssets()
Vector3 spawnPosition = gameManager.DefaultSpawnPoint.position;
yield return VRMUtility.LoadAndSetupVrmFromPath(vrmPath, spawnPosition, ...);
```

すべて同じ`gameManager.DefaultSpawnPoint.position`を使用しています。

## 動作確認

### 期待される動作:

1. **GameManagerでDefaultSpawnPointを設定**: シーン内の1つのTransform
2. **VRM読み込み**: PlayableCharacterRepositoryとVRMLoadManagerが同じ位置にVRMをスポーン
3. **リスポーン**: GameManagerが同じ位置にキャラクターをリスポーン

### テスト手順:

1. Unity Editorでシーンを開く
2. GameManagerを選択し、Default Spawn Pointを設定
3. PlayableCharacterRepositoryを選択し、Game Managerを設定（GameManagerへの参照）
4. VRMLoadManagerを選択し、Game Managerが設定されていることを確認
5. ゲームを実行して、VRM読み込みが正しい位置で行われることを確認
6. キャラクターが死亡してリスポーンすることを確認（同じ位置）

## 備考

- DefaultSpawnPointの設定をGameManagerに一元化しました
- PlayableCharacterRepositoryとVRMLoadManagerからGameManagerのDefaultSpawnPointを参照するように修正しました
- PlayableCharacterRepository.defaultSpawnPointフィールドを削除し、gameManagerフィールドを追加しました
- VRMLoadManager.defaultSpawnPointフィールドを削除しました
- GameManager.DefaultSpawnPointプロパティ（public）を追加しました
- スポーン位置取得処理を4箇所（PlayableCharacterRepository: 1箇所、VRMLoadManager: 3箇所）で変更しました
- 診断ツールで確認した結果、コンパイルエラーはありませんでした
- Single Source of Truthパターンにより、設定の一元化、不整合の防止、保守性の向上を実現しました
