# 作業レポート 2025-10-16 22:59

## 変更内容の概要

- 看板に近づくとメッセージが表示される機能を実装しました
- GameUIManagerにメッセージ表示・非表示機能を追加しました
- GameCharacterCollisionTriggerにStaticMessageタグの検出処理を追加しました

## 変更理由

ユーザーから「看板を配置し、キャラが近づくとメッセージが表示されるようにします。メッセージ表示オブジェクトにはSphere Colliderを設置し、『StaticMessage』タグを設定しています。メッセージ表示枠のUIを準備しました。まずCanvasGroupの参照がGameUIManagerの『staticMessageCanvasGroup』に設定されています。このalphaで表示・非表示を行ってください。該当のオブジェクトは『Static Messenger』コンポーネントをもち、表示するテキスト情報を設定可能になっています。public string Messageゲッターで内容を取得できます。メッセージ表示用のTextMessageProUGUIの参照をGameUIManagerの『staticMessageTMP』に設定しています。コリジョンに入って表示を開始するタイミングでテキスト内容を更新してください。」という指示がありました。

### 実装の詳細

1. **StaticMessengerコンポーネント（既存）:**
   - 看板オブジェクトにアタッチ
   - `Message`プロパティで表示するテキストを設定可能

2. **GameUIManager:**
   - `staticMessageCanvasGroup`と`staticMessageTMP`の参照を持つ（既存）
   - `ShowStaticMessage(string message)`メソッドを追加
   - `HideStaticMessage()`メソッドを追加

3. **GameCharacterCollisionTrigger:**
   - `OnTriggerEnter()`でStaticMessageタグを検出
   - `OnTriggerExit()`で離れたことを検出
   - GameUIManagerを通じてメッセージを表示・非表示

## 変更したファイル

### 変更: Assets/Scripts/GameManager/GameUIManager.cs

**Start()メソッドの更新 (45-53行目):**

```csharp
void Start()
{
    fpsCounterFrame?.SetActive(enableFpsCounter);

    // メッセージ表示枠を初期状態で非表示
    if (staticMessageCanvasGroup != null)
    {
        staticMessageCanvasGroup.alpha = 0f;
    }

    // UserDataManagerのreactive property購読・更新
```

**変更前:**
```csharp
void Start()
{
    fpsCounterFrame?.SetActive(enableFpsCounter);

    // UserDataManagerのreactive property購読・更新
```

**変更後:**
メッセージ表示枠を初期状態で非表示（alpha = 0）にするようにしました。

**ShowStaticMessage()メソッドの追加 (124-141行目):**

```csharp
/// <summary>
/// 静的メッセージを表示する
/// </summary>
/// <param name="message">表示するメッセージ</param>
public void ShowStaticMessage(string message)
{
    if (staticMessageCanvasGroup == null || staticMessageTMP == null)
    {
        Debug.LogWarning("GameUIManager: staticMessageCanvasGroupまたはstaticMessageTMPが設定されていません。");
        return;
    }

    // テキスト内容を更新
    staticMessageTMP.text = message;

    // メッセージ表示枠を表示
    staticMessageCanvasGroup.alpha = 1f;
}
```

メッセージを表示するメソッドを追加しました。`staticMessageTMP.text`にメッセージ内容を設定し、`staticMessageCanvasGroup.alpha`を1にして表示します。

**HideStaticMessage()メソッドの追加 (143-155行目):**

```csharp
/// <summary>
/// 静的メッセージを非表示にする
/// </summary>
public void HideStaticMessage()
{
    if (staticMessageCanvasGroup == null)
    {
        return;
    }

    // メッセージ表示枠を非表示
    staticMessageCanvasGroup.alpha = 0f;
}
```

メッセージを非表示にするメソッドを追加しました。`staticMessageCanvasGroup.alpha`を0にして非表示にします。

### 変更: Assets/Scripts/Character/GameCharacterCollisionTrigger.cs

**フィールドの追加 (21-23行目):**

```csharp
[Header("UI管理")]
[Tooltip("GameUIManager（StaticMessage表示用）")]
[SerializeField] private GameUIManager uiManager;
```

GameUIManagerへの参照を保持するフィールドを追加しました。

**Awake()メソッドの追加 (25-36行目):**

```csharp
void Awake()
{
    // GameUIManagerの自動検出
    if (uiManager == null)
    {
        uiManager = FindFirstObjectByType<GameUIManager>();
        if (uiManager == null)
        {
            Debug.LogWarning("GameCharacterCollisionTrigger: GameUIManagerが見つかりません。StaticMessage表示機能は動作しません。");
        }
    }
}
```

GameUIManagerを自動検出するAwake()メソッドを追加しました。

**OnTriggerEnter()メソッドの更新 (41-65行目):**

```csharp
void OnTriggerEnter(Collider other)
{
    //Debug.Log($"GameCharacterCollisionTrigger: Trigger entered with {other.name}, tag: {other.tag}");

    // コインタグのオブジェクトに触れたかチェック
    if (other.CompareTag("Coin"))
    {
        CollectCoin(other.gameObject);
    }
    // ダメージソースタグのオブジェクトに触れたかチェック
    else if (other.CompareTag("DamageSource"))
    {
        TakeDamageFromSource(other.gameObject);
    }
    // DeadZoneタグのオブジェクトに触れたかチェック
    else if (other.CompareTag("DeadZone"))
    {
        EnterDeadZone(other.gameObject);
    }
    // StaticMessageタグのオブジェクトに触れたかチェック
    else if (other.CompareTag("StaticMessage"))
    {
        EnterStaticMessage(other.gameObject);
    }
}
```

**変更前:**
```csharp
void OnTriggerEnter(Collider other)
{
    //Debug.Log($"GameCharacterCollisionTrigger: Trigger entered with {other.name}, tag: {other.tag}");

    // コインタグのオブジェクトに触れたかチェック
    if (other.CompareTag("Coin"))
    {
        CollectCoin(other.gameObject);
    }
    // ダメージソースタグのオブジェクトに触れたかチェック
    else if (other.CompareTag("DamageSource"))
    {
        TakeDamageFromSource(other.gameObject);
    }
    // DeadZoneタグのオブジェクトに触れたかチェック
    else if (other.CompareTag("DeadZone"))
    {
        EnterDeadZone(other.gameObject);
    }
}
```

**変更後:**
StaticMessageタグの検出処理を追加しました。

**OnTriggerExit()メソッドの追加 (67-77行目):**

```csharp
/// <summary>
/// トリガーコライダーから出たときに呼ばれる
/// </summary>
void OnTriggerExit(Collider other)
{
    // StaticMessageタグのオブジェクトから離れたかチェック
    if (other.CompareTag("StaticMessage"))
    {
        ExitStaticMessage(other.gameObject);
    }
}
```

トリガーコライダーから出たときの処理を追加しました。StaticMessageタグから離れたことを検出します。

**EnterStaticMessage()メソッドの追加 (142-165行目):**

```csharp
/// <summary>
/// StaticMessageに入った時の処理
/// </summary>
/// <param name="staticMessage">StaticMessageのGameObject</param>
void EnterStaticMessage(GameObject staticMessage)
{
    // StaticMessengerスクリプトを取得
    StaticMessenger messenger = staticMessage.GetComponent<StaticMessenger>();
    if (messenger == null)
    {
        Debug.LogWarning($"GameCharacterCollisionTrigger: {staticMessage.name} にStaticMessengerスクリプトがありません。");
        return;
    }

    // UIManagerが設定されていない場合は処理しない
    if (uiManager == null)
    {
        Debug.LogWarning("GameCharacterCollisionTrigger: GameUIManagerが設定されていません。StaticMessageを表示できません。");
        return;
    }

    // メッセージを表示
    uiManager.ShowStaticMessage(messenger.Message);
}
```

StaticMessageタグのオブジェクトに入った時の処理を追加しました。StaticMessengerコンポーネントからメッセージを取得し、GameUIManagerを通じて表示します。

**ExitStaticMessage()メソッドの追加 (167-181行目):**

```csharp
/// <summary>
/// StaticMessageから出た時の処理
/// </summary>
/// <param name="staticMessage">StaticMessageのGameObject</param>
void ExitStaticMessage(GameObject staticMessage)
{
    // UIManagerが設定されていない場合は処理しない
    if (uiManager == null)
    {
        return;
    }

    // メッセージを非表示
    uiManager.HideStaticMessage();
}
```

StaticMessageタグのオブジェクトから出た時の処理を追加しました。GameUIManagerを通じてメッセージを非表示にします。

## アーキテクチャの設計

### メッセージ表示の仕組み

```
看板オブジェクト:
  - StaticMessengerコンポーネント（メッセージ内容を保持）
  - Sphere Collider（Is Trigger = true）
  - タグ: "StaticMessage"

キャラクター:
  - GameCharacterCollisionTrigger（コリジョン検出）
    ↓
  OnTriggerEnter() でStaticMessageタグを検出
    ↓
  StaticMessenger.Message を取得
    ↓
  GameUIManager.ShowStaticMessage() を呼び出し
    ↓
  staticMessageTMP.text にメッセージを設定
  staticMessageCanvasGroup.alpha を 1 に設定（表示）

キャラクターが離れる:
  - GameCharacterCollisionTrigger
    ↓
  OnTriggerExit() でStaticMessageタグを検出
    ↓
  GameUIManager.HideStaticMessage() を呼び出し
    ↓
  staticMessageCanvasGroup.alpha を 0 に設定（非表示）
```

### コンポーネント間の関係

```
StaticMessenger
  ↓ Message プロパティ
GameCharacterCollisionTrigger
  ↓ ShowStaticMessage() / HideStaticMessage()
GameUIManager
  ↓ alpha 制御
CanvasGroup（メッセージ表示枠）
  ↓ text 設定
TextMeshProUGUI（メッセージテキスト）
```

### 処理の流れ

1. **初期化（GameUIManager.Start()）:**
   - `staticMessageCanvasGroup.alpha = 0f`でメッセージ表示枠を非表示

2. **キャラクターが看板に近づく（OnTriggerEnter）:**
   - StaticMessageタグを検出
   - StaticMessengerコンポーネントから`Message`を取得
   - `GameUIManager.ShowStaticMessage(message)`を呼び出し
   - `staticMessageTMP.text = message`でテキスト内容を設定
   - `staticMessageCanvasGroup.alpha = 1f`で表示

3. **キャラクターが看板から離れる（OnTriggerExit）:**
   - StaticMessageタグを検出
   - `GameUIManager.HideStaticMessage()`を呼び出し
   - `staticMessageCanvasGroup.alpha = 0f`で非表示

## 利点

### 1. シンプルなUI制御

CanvasGroupのalpha値を0/1で切り替えるだけでメッセージの表示・非表示を制御できます。

### 2. 柔軟なメッセージ設定

各看板オブジェクトにStaticMessengerコンポーネントをアタッチし、Inspectorでメッセージ内容を設定できます。

### 3. 自動検出

GameCharacterCollisionTriggerが自動的にGameUIManagerを検出するため、手動での設定が不要です。

### 4. 他の機能との統合

既存のGameCharacterCollisionTriggerに処理を追加することで、コイン取得、ダメージ、DeadZone、StaticMessageのすべてを一元的に管理できます。

## 使用例

### シーン設定

**看板オブジェクト:**
1. GameObjectを作成（例: SignPost）
2. StaticMessengerコンポーネントをアタッチ
3. Messageフィールドにテキストを設定（例: "ようこそ！"）
4. Sphere Colliderをアタッチ
5. Is Triggerをtrueに設定
6. タグを"StaticMessage"に設定

**GameUIManager:**
1. CanvasGroupを持つUI要素を作成（メッセージ表示枠）
2. TextMeshProUGUIを作成（メッセージテキスト）
3. GameUIManagerの`staticMessageCanvasGroup`にCanvasGroupを設定
4. GameUIManagerの`staticMessageTMP`にTextMeshProUGUIを設定

**キャラクター:**
1. GameCharacterCollisionTriggerコンポーネントをアタッチ（既存）
2. GameUIManagerは自動検出される

### 実行時の動作

1. キャラクターが看板のSphere Colliderに入る
2. メッセージ表示枠が表示される（alpha = 1）
3. テキストが"ようこそ！"に更新される
4. キャラクターが看板から離れる
5. メッセージ表示枠が非表示になる（alpha = 0）

### 複数の看板

複数の看板を配置する場合：

```
SignPost1:
  - StaticMessenger: Message = "ようこそ！"
  - Sphere Collider (Is Trigger = true)
  - タグ: "StaticMessage"

SignPost2:
  - StaticMessenger: Message = "注意：前方に敵がいます"
  - Sphere Collider (Is Trigger = true)
  - タグ: "StaticMessage"

SignPost3:
  - StaticMessenger: Message = "ゴールまであと少し！"
  - Sphere Collider (Is Trigger = true)
  - タグ: "StaticMessage"
```

キャラクターが各看板に近づくたびに、対応するメッセージが表示されます。

## 動作確認

### 期待される動作:

1. **初期状態**: メッセージ表示枠が非表示（alpha = 0）
2. **看板に近づく**: メッセージ表示枠が表示され、看板のメッセージが表示される（alpha = 1）
3. **看板から離れる**: メッセージ表示枠が非表示になる（alpha = 0）
4. **複数の看板**: 各看板に近づくたびに、対応するメッセージが表示される
5. **GameUIManager未設定**: 警告ログが表示され、メッセージ表示機能は動作しない

### テスト手順:

1. Unity Editorでシーンを開く
2. 看板オブジェクトを作成
3. StaticMessengerコンポーネントをアタッチし、Messageを設定
4. Sphere Colliderをアタッチし、Is Triggerをtrueに設定
5. タグを"StaticMessage"に設定
6. GameUIManagerのstaticMessageCanvasGroupとstaticMessageTMPを設定
7. ゲームを実行して、キャラクターが看板に近づくことを確認
8. メッセージ表示枠が表示され、テキストが更新されることを確認
9. キャラクターが看板から離れることを確認
10. メッセージ表示枠が非表示になることを確認

## 備考

- 看板に近づくとメッセージが表示される機能を実装しました
- GameUIManagerにShowStaticMessage()とHideStaticMessage()メソッドを追加しました
- GameCharacterCollisionTriggerにStaticMessageタグの検出処理を追加しました
- CanvasGroup.alphaで表示・非表示を制御します
- StaticMessenger.Messageプロパティからメッセージ内容を取得します
- OnTriggerEnter()でメッセージ表示、OnTriggerExit()でメッセージ非表示を行います
- GameUIManagerは自動検出されます
- 診断ツールで確認した結果、コンパイルエラーはありませんでした
- GameUIManager.cs: 149行 → 188行（39行増加、約26%増加）
- GameCharacterCollisionTrigger.cs: 108行 → 183行（75行増加、約69%増加）
