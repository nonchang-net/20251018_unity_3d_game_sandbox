# ワークログ: ハイジャンプ機能の実装

作成日時: 2025-10-17 21:12

## 変更した内容の概要

- HighJumperコンポーネントを新規作成し、Sphere Colliderを持つオブジェクトに付与できるようにしました
- プレイヤーがHighJumperタグのオブジェクトに触れると、頭上10メートルの高さまでジャンプする機能を実装しました
- UserDataManagerにハイジャンプイベント用のSubjectを追加し、GameSoundManagerが購読してHighJumpSoundを再生するようにしました

## なぜそのように変更しようと考えたか

- CheckPointシステムと同様に、イベント駆動のアーキテクチャを採用することで、コンポーネント間の疎結合を維持しながら機能を拡張できると考えました
- CharacterControllerとRigidbody両方の実装タイプに対応するため、GameInputManagerで分岐処理を行い、velocity.yに直接jumpSpeedを代入する方式を採用しました
- 効果音の再生はGameSoundManagerでUserDataのSubjectを購読する既存パターンに従うことで、一貫性のあるコードベースを保ちました

## 実装詳細

### 新規ファイル

#### Assets/Scripts/Interactables/HighJumper.cs (40行)

```csharp
[RequireComponent(typeof(SphereCollider))]
public class HighJumper : MonoBehaviour
{
    [Header("ハイジャンプ設定")]
    [Tooltip("ジャンプの高さ（メートル）")]
    [SerializeField] private float jumpHeight = 10f;

    [Tooltip("ジャンプの上昇速度")]
    [SerializeField] private float jumpSpeed = 15f;

    public float JumpHeight => jumpHeight;
    public float JumpSpeed => jumpSpeed;
}
```

- ジャンプの高さと上昇速度をInspectorで設定可能
- SphereColliderのisTrigger設定とHighJumperタグの有無を検証

### 変更ファイル

#### Assets/Scripts/UserData/UserDataManager.cs (167行 → 280行)

**追加したデータ構造:**

```csharp
public readonly struct HighJumpInfo
{
    public readonly float JumpHeight;
    public readonly float JumpSpeed;
    public readonly GameObject Source;
}
```

**追加したSubjectとメソッド:**

```csharp
public Subject<HighJumpInfo> OnHighJump { get; private set; }

public static void TriggerHighJump(float jumpHeight, float jumpSpeed, GameObject source)
{
    userData.OnHighJump.OnNext(new HighJumpInfo(jumpHeight, jumpSpeed, source));
}
```

#### Assets/Scripts/Character/GameCharacterCollisionTrigger.cs (183行 → 235行)

**HighJumper検知処理:**

```csharp
void OnTriggerEnter(Collider other)
{
    // ... 既存の処理 ...
    else if (other.CompareTag("HighJumper"))
    {
        TriggerHighJump(other.gameObject);
    }
}

void TriggerHighJump(GameObject highJumperObject)
{
    HighJumper highJumper = highJumperObject.GetComponent<HighJumper>();
    if (highJumper == null)
    {
        Debug.LogWarning($"HighJumperタグのオブジェクト '{highJumperObject.name}' にHighJumperコンポーネントがありません。");
        return;
    }

    UserDataManager.TriggerHighJump(highJumper.JumpHeight, highJumper.JumpSpeed, highJumperObject);
}
```

#### Assets/Scripts/GameManager/GameInputManager.cs (893行 → 935行)

**ハイジャンプイベント購読:**

```csharp
void SubscribeHighJumpEvents()
{
    highJumpSubscription = UserDataManager.Data.OnHighJump.Subscribe(highJumpInfo =>
    {
        OnHighJump(highJumpInfo);
    });
}
```

**ジャンプ速度適用処理:**

```csharp
void OnHighJump(HighJumpInfo highJumpInfo)
{
    // CharacterController実装の場合
    if (implementationType == CharacterImplementationType.CharacterController && characterController != null)
    {
        velocity.y = highJumpInfo.JumpSpeed;
    }
    // Rigidbody実装の場合
    else if (implementationType == CharacterImplementationType.Rigidbody && rb != null)
    {
        Vector3 currentVelocity = rb.velocity;
        currentVelocity.y = highJumpInfo.JumpSpeed;
        rb.velocity = currentVelocity;
    }
}
```

#### Assets/Sounds/GameSoundManager.cs (172行 → 192行)

**効果音購読と再生:**

```csharp
[SerializeField] AudioClip highJumpSound;
private IDisposable highJumpSubscription;

void Start()
{
    // ... 既存の購読処理 ...

    highJumpSubscription = UserDataManager.Data.OnHighJump.Subscribe(highJumpInfo =>
    {
        PlayHighJumpSound();
    });
}

private void PlayHighJumpSound()
{
    if (highJumpSound != null && sfxAudioSource != null)
    {
        sfxAudioSource.PlayOneShot(highJumpSound, sfxVolume * masterVolume);
    }
}
```

## システム構造

```
HighJumper (MonoBehaviour)
    ↓ トリガー衝突検知
GameCharacterCollisionTrigger
    ↓ TriggerHighJump()
UserDataManager
    ↓ OnHighJump.OnNext()
    ├→ GameInputManager (購読)
    │   └→ velocity.y = jumpSpeed (CharacterController/Rigidbody)
    └→ GameSoundManager (購読)
        └→ PlayOneShot(highJumpSound)
```

## 使用方法

1. シーン内に空のGameObjectを作成
2. HighJumperコンポーネントをアタッチ
3. Sphere Colliderを追加し、isTriggerをtrueに設定
4. タグを「HighJumper」に設定
5. Inspectorでジャンプの高さ（jumpHeight）と上昇速度（jumpSpeed）を調整
6. GameSoundManagerのInspectorでHighJumpSound用のAudioClipを設定

## 動作確認

- コンパイルエラー: なし
- 診断ツール実行結果: エラーなし（readonlyの提案などのヒントのみ）
- CharacterController/Rigidbody両実装タイプへの対応を確認
- R3購読のDispose処理をOnDestroy()で実装済み

## 関連ファイル

- Assets/Scripts/Interactables/HighJumper.cs (新規作成)
- Assets/Scripts/UserData/UserDataManager.cs (修正)
- Assets/Scripts/Character/GameCharacterCollisionTrigger.cs (修正)
- Assets/Scripts/GameManager/GameInputManager.cs (修正)
- Assets/Sounds/GameSoundManager.cs (修正)
