# ワークログ: コイン総数UI表示機能の実装

作成日時: 2025-10-18 01:06

## 変更した内容の概要

- UserDataManagerにTotalCoinCountのReactivePropertyとOnCoinGeneratedのSubjectを追加しました
- Coinコンポーネント自体のAwakeメソッドで、生成時にUserDataManagerに自己報告するようにしました
- GameUIManagerでTotalCoinCountを購読し、「取得コイン数/総コイン数」の形式でUI表示するようにしました

## なぜそのように変更しようと考えたか

- シーン全体のコンポーネント検索は重い処理なので、コイン生成時にカウントする方式を採用しました
- 当初はPrefabScatterから通知する実装でしたが、手動配置したコインが計上されない問題があったため、Coinコンポーネント自体が自己報告する方式に変更しました
- Reactive Propertyを使用することで、コイン生成時とコイン取得時の両方でUIが自動的に更新されるリアクティブな仕組みを実現しました

## 実装詳細

### UserDataManager.cs の変更 (280行 → 328行)

#### 新規データ構造の追加

```csharp
/// <summary>
/// コイン生成情報
/// </summary>
public readonly struct CoinGeneratedInfo
{
    /// <summary>生成されたコイン数</summary>
    public readonly int GeneratedCount;

    /// <summary>生成ソース（どのオブジェクトから生成されたか）</summary>
    public readonly GameObject Source;

    public CoinGeneratedInfo(int generatedCount, GameObject source)
    {
        GeneratedCount = generatedCount;
        Source = source;
    }
}
```

#### UserDataクラスへの追加

```csharp
/// <summary>
/// ステージに生成されたコインの総数
/// </summary>
public ReactiveProperty<int> TotalCoinCount { get; private set; }

/// <summary>
/// コインが生成されたときに発火するSubject
/// 生成されたコイン数、生成ソースを通知
/// </summary>
public Subject<CoinGeneratedInfo> OnCoinGenerated { get; private set; }

public UserData(int initialHp)
{
    CurrentCoin = new ReactiveProperty<int>(0);
    TotalCoinCount = new ReactiveProperty<int>(0);  // 追加
    // ... 既存の初期化 ...
    OnCoinGenerated = new Subject<CoinGeneratedInfo>();  // 追加
    // ...
}
```

#### UserDataManagerクラスへの追加

```csharp
/// <summary>
/// コインが生成されたことを通知
/// </summary>
/// <param name="count">生成されたコイン数</param>
/// <param name="source">生成ソース（GameObject）</param>
public static void AddGeneratedCoins(int count, GameObject source)
{
    // 総コイン数を増やす
    int newTotal = userData.TotalCoinCount.CurrentValue + count;
    userData.TotalCoinCount.Value = newTotal;

    // コイン生成イベントを発火
    userData.OnCoinGenerated.OnNext(new CoinGeneratedInfo(count, source));

    Debug.Log($"UserDataManager: コインが{count}枚生成されました。総数: {newTotal}");
}
```

### Coin.cs の変更 (177行 → 182行)

#### Awakeメソッドの追加

```csharp
void Awake()
{
    // コイン生成をUserDataManagerに通知
    UserDataManager.AddGeneratedCoins(1, gameObject);
}
```

各Coinコンポーネントが生成されたタイミング（Awake）で自己報告することで、以下の利点があります：
- PrefabScatterから生成されたコインも、手動配置されたコインも、すべて自動的にカウントされる
- PrefabScatter側に特別な処理を追加する必要がない
- よりシンプルでメンテナンスしやすい設計

### GameUIManager.cs の変更 (70-80行, 100-105行)

#### TotalCoinCount購読の追加

```csharp
// Coin変動購読
var coinSubscriber = UserDataManager.Data.CurrentCoin.Subscribe(x =>
{
    int totalCoin = UserDataManager.Data.TotalCoinCount.CurrentValue;
    currentCoinText.SetText($"{x}/{totalCoin}");
});

// TotalCoinCount変動購読（コイン生成時に総数を更新）
var totalCoinSubscriber = UserDataManager.Data.TotalCoinCount.Subscribe(totalCoin =>
{
    int currentCoin = UserDataManager.Data.CurrentCoin.CurrentValue;
    currentCoinText.SetText($"{currentCoin}/{totalCoin}");
});
```

#### Disposable登録の更新

```csharp
// disposable登録
disposable = Disposable.Combine(
    coinSubscriber,
    totalCoinSubscriber,  // 追加
    hitpointSubscriber,
    damageSubscriber
);
```

#### 既存のmockTotalCoinの削除

```diff
- // TODO: 生成されたコイン総数をUserDataから取得できるようにする
- var mockTotalCoin = 100;
- currentCoinText.SetText($"{x}/{mockTotalCoin}");
+ int totalCoin = UserDataManager.Data.TotalCoinCount.CurrentValue;
+ currentCoinText.SetText($"{x}/{totalCoin}");
```

## システム構造

```
Coin (MonoBehaviour)
    ↓ Awake()で自己報告
UserDataManager.AddGeneratedCoins(1, source)
    ↓ TotalCoinCount.Value += 1
    ↓ OnCoinGenerated.OnNext()
GameUIManager (購読)
    ├→ CurrentCoin購読: currentCoinText表示更新
    └→ TotalCoinCount購読: currentCoinText表示更新
```

### 生成元による違い

- **PrefabScatterから生成**: Instantiate()後のAwakeで自動報告
- **手動配置（シーンに直接配置）**: シーン開始時のAwakeで自動報告
- どちらの方法でも確実にカウントされる

## UIテキスト表示フォーマット

```
「{取得したコイン数}/{ステージの総コイン数}」
例: "5/100" (100枚中5枚取得済み)
```

## 動作確認

- コンパイルエラー: なし
- 診断ツール実行結果: エラーなし（ヒントのみ）
- Reactive Property購読のDispose処理: 適切に実装済み（GameUIManagerのdisposableに追加）

## 利点

1. **パフォーマンス**: シーン全体の検索を避け、生成時にカウントする方式で軽量化
2. **リアクティブ**: コイン生成時とコイン取得時の両方でUIが自動更新される
3. **完全性**: PrefabScatter生成とシーン手動配置の両方に対応
4. **シンプルさ**: Coinコンポーネント自身が責任を持つ自己報告パターンで、他のクラスへの依存がない

## 修正履歴

### 初回実装 (削除済み)
- PrefabScatter系クラスから通知する方式
- 問題点: 手動配置されたコインが計上されない

### 最終実装 (現在)
- Coin.Awake()で自己報告する方式
- 解決: すべてのコインが確実にカウントされる

## 関連ファイル

- Assets/Scripts/UserData/UserDataManager.cs (修正)
- Assets/Scripts/Interactables/Coin.cs (修正)
- Assets/Scripts/GameManager/GameUIManager.cs (修正)
