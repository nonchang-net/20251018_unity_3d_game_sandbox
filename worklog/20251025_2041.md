# ワークログ: ポーズメニュー設定機能の実装

作成日時: 2025-10-25 20:41

## 変更した内容の概要

- GameSettings.csを新規作成し、ゲーム設定値の管理とPlayerPrefsへの永続化機能を実装しました
- GameUIManager.csにポーズメニューのUI要素（Toggle、Slider、Button）の参照と制御機能を追加しました
- CharacterTracker.csにカメラ設定（上下反転、マウス感度）を反映する機能を追加しました
- 設定値はPlayerPrefsに保存され、ゲーム再起動時に自動的にロードされます

## なぜそのように変更しようと考えたか

- ユーザーが自分の操作感覚に合わせてゲームをカスタマイズできるようにするため
- 設定値を永続化することで、毎回設定し直す手間を省き、ユーザーエクスペリエンスを向上させるため
- カメラ操作やオーディオ設定を一元管理し、ゲーム全体で統一的な設定を適用するため

## 実装詳細

### 1. GameSettings.cs の新規作成

#### 責務
- ゲーム設定値の管理
- PlayerPrefsへの設定値の保存・読み込み
- 設定値の変更とデフォルト値へのリセット

#### フィールドと定数

```csharp
// PlayerPrefsのキー定義
private const string KEY_CAMERA_INVERT_Y = "Settings_CameraInvertY";
private const string KEY_MOUSE_SENSITIVITY = "Settings_MouseSensitivity";
private const string KEY_BGM_VOLUME = "Settings_BGMVolume";
private const string KEY_SE_VOLUME = "Settings_SEVolume";

// デフォルト値
public const bool DEFAULT_CAMERA_INVERT_Y = false;
public const float DEFAULT_MOUSE_SENSITIVITY = 100f;  // 100%
public const float DEFAULT_BGM_VOLUME = 0.8f;         // 80%
public const float DEFAULT_SE_VOLUME = 0.8f;          // 80%

/// <summary>上下カメラ操作方向反転</summary>
public bool CameraInvertY { get; private set; }

/// <summary>マウス感度（10% ～ 300%）</summary>
public float MouseSensitivity { get; private set; }

/// <summary>BGMボリューム（0.0 ～ 1.0）</summary>
public float BGMVolume { get; private set; }

/// <summary>サウンドエフェクトボリューム（0.0 ～ 1.0）</summary>
public float SEVolume { get; private set; }
```

#### 主要メソッド

**LoadSettings()**: PlayerPrefsから設定値をロード
```csharp
public void LoadSettings()
{
    CameraInvertY = PlayerPrefs.GetInt(KEY_CAMERA_INVERT_Y, DEFAULT_CAMERA_INVERT_Y ? 1 : 0) == 1;
    MouseSensitivity = PlayerPrefs.GetFloat(KEY_MOUSE_SENSITIVITY, DEFAULT_MOUSE_SENSITIVITY);
    BGMVolume = PlayerPrefs.GetFloat(KEY_BGM_VOLUME, DEFAULT_BGM_VOLUME);
    SEVolume = PlayerPrefs.GetFloat(KEY_SE_VOLUME, DEFAULT_SE_VOLUME);
}
```

**SaveSettings()**: 現在の設定値をPlayerPrefsに保存
```csharp
public void SaveSettings()
{
    PlayerPrefs.SetInt(KEY_CAMERA_INVERT_Y, CameraInvertY ? 1 : 0);
    PlayerPrefs.SetFloat(KEY_MOUSE_SENSITIVITY, MouseSensitivity);
    PlayerPrefs.SetFloat(KEY_BGM_VOLUME, BGMVolume);
    PlayerPrefs.SetFloat(KEY_SE_VOLUME, SEVolume);
    PlayerPrefs.Save();
}
```

**各種Setterメソッド**: 設定値を変更して自動保存
- `SetCameraInvertY(bool value)`
- `SetMouseSensitivity(float value)`: 10% ～ 300%に制限
- `SetBGMVolume(float value)`: 0.0 ～ 1.0に制限
- `SetSEVolume(float value)`: 0.0 ～ 1.0に制限

**ResetToDefault()**: すべての設定値をデフォルトに戻す

### 2. GameUIManager.cs の変更

#### 新規追加したSerializeField（65-91行目）

```csharp
[Header("ポーズメニューUI要素")]
[Tooltip("上下カメラ操作方向反転Toggle")]
[SerializeField] private Toggle cameraInvertYToggle;

[Tooltip("マウス感度調整スライダー")]
[SerializeField] private Slider mouseSensitivitySlider;

[Tooltip("マウス感度表示テキスト")]
[SerializeField] private TextMeshProUGUI mouseSensitivityText;

[Tooltip("BGMボリューム調整スライダー")]
[SerializeField] private Slider bgmVolumeSlider;

[Tooltip("BGMボリューム表示テキスト")]
[SerializeField] private TextMeshProUGUI bgmVolumeText;

[Tooltip("サウンドエフェクトボリューム調整スライダー")]
[SerializeField] private Slider seVolumeSlider;

[Tooltip("サウンドエフェクトボリューム表示テキスト")]
[SerializeField] private TextMeshProUGUI seVolumeText;

[Tooltip("デフォルトに戻すボタン")]
[SerializeField] private Button resetToDefaultButton;

[Tooltip("再開ボタン")]
[SerializeField] private Button resumeButton;
```

#### Start()での初期化追加（131-133行目）

```csharp
// ゲーム設定の初期化とロード
gameSettings = new GameSettings();
InitializePauseMenuUI();
```

#### InitializePauseMenuUI()（443-494行目）

ポーズメニューUIの初期化処理:
- スライダーの範囲設定
  - マウス感度: 10% ～ 300%、整数値のみ
  - BGM/SEボリューム: 0.0 ～ 1.0
- イベントリスナーの登録
- 初期値の表示更新

#### UpdateSettingsUI()（496-539行目）

設定UIの表示を更新:
- 各スライダーの値を設定値から反映
- 表示テキストを更新（パーセント表示）
- CharacterTrackerにカメラ設定を反映

#### ApplyCameraSettings()（541-551行目）

```csharp
private void ApplyCameraSettings()
{
    if (gameManager?.CharacterTracker != null)
    {
        gameManager.CharacterTracker.SetCameraInvertY(gameSettings.CameraInvertY);
        gameManager.CharacterTracker.SetMouseSensitivity(gameSettings.MouseSensitivity / 100f);
    }
}
```

#### 各種イベントハンドラー

**OnMouseSensitivityChanged()** (553-570行目)
- 10%刻みに丸める処理
- 表示テキストの更新
- カメラへの反映

**OnBGMVolumeChanged()** (572-587行目)
- ボリューム値の保存
- 表示テキストの更新
- TODO: AudioManagerへの反映（将来実装）

**OnSEVolumeChanged()** (589-604行目)
- ボリューム値の保存
- 表示テキストの更新
- TODO: AudioManagerへの反映（将来実装）

**OnCameraInvertYChanged()** (606-615行目)
- カメラ反転設定の保存
- カメラへの反映

**OnResetToDefaultClicked()** (617-624行目)
- すべての設定値をデフォルトに戻す
- UIの表示更新

**OnResumeClicked()** (626-633行目)
- ゲームのポーズを解除
- ポーズメニューを非表示

### 3. CharacterTracker.cs の変更

#### 新規追加したフィールド（16行目）

```csharp
[SerializeField] private float mouseSensitivityMultiplier = 1f; // マウス感度倍率
```

#### HandleCameraRotation()の変更（81-99行目）

マウス感度倍率を入力に適用:
```csharp
float lookX = lookInput.x * mouseSensitivityMultiplier;
float lookY = lookInput.y * mouseSensitivityMultiplier;
```

#### 新規追加した公開メソッド

**SetCameraInvertY()** (249-256行目)
```csharp
/// <summary>
/// カメラの上下反転設定を変更
/// </summary>
/// <param name="invert">true: 反転、false: 通常</param>
public void SetCameraInvertY(bool invert)
{
    invertVerticalAxis = invert;
}
```

**SetMouseSensitivity()** (258-266行目)
```csharp
/// <summary>
/// マウス感度倍率を設定
/// </summary>
/// <param name="multiplier">感度倍率（0.1 ～ 3.0）</param>
public void SetMouseSensitivity(float multiplier)
{
    mouseSensitivityMultiplier = Mathf.Clamp(multiplier, 0.1f, 3.0f);
}
```

## データフロー

### 設定値の保存フロー

```
ユーザーがUIを操作（Slider/Toggle）
    ↓
UIイベントハンドラー（OnXXXChanged）
    ↓
GameSettings.SetXXX()
    ├→ 設定値を更新
    └→ PlayerPrefs.SetXXX()で自動保存
    ↓
ApplyCameraSettings() / AudioManager（TODO）
    ↓
設定値が即座にゲームに反映される
```

### 設定値のロードフロー

```
ゲーム起動
    ↓
GameUIManager.Start()
    ├→ gameSettings = new GameSettings()
    │   └→ LoadSettings()がコンストラクタで呼ばれる
    │       └→ PlayerPrefs.GetXXX()で設定値をロード
    ↓
InitializePauseMenuUI()
    ├→ スライダーとToggleに設定値を反映
    └→ UpdateSettingsUI()
        ├→ 表示テキストを更新
        └→ ApplyCameraSettings()
            └→ CharacterTrackerに設定を反映
```

### デフォルトリセットフロー

```
「デフォルトに戻す」ボタンクリック
    ↓
OnResetToDefaultClicked()
    ↓
GameSettings.ResetToDefault()
    ├→ すべての設定値をデフォルト値に戻す
    └→ SaveSettings()で保存
    ↓
UpdateSettingsUI()
    ├→ UIの表示を更新
    └→ ゲームに反映
```

## UI設定仕様

### マウス感度スライダー
- **範囲**: 10% ～ 300%
- **刻み**: 10%（wholeNumbers = true、OnMouseSensitivityChangedで10刻みに丸める）
- **デフォルト**: 100%
- **表示**: "100%"のようにパーセント表示

### BGMボリュームスライダー
- **範囲**: 0.0 ～ 1.0
- **デフォルト**: 0.8（80%）
- **表示**: "80%"のようにパーセント表示

### サウンドエフェクトボリュームスライダー
- **範囲**: 0.0 ～ 1.0
- **デフォルト**: 0.8（80%）
- **表示**: "80%"のようにパーセント表示

### カメラ上下反転Toggle
- **デフォルト**: false（反転なし）
- **即座反映**: Toggleを変更すると即座にカメラ操作に反映

## PlayerPrefs保存キー

```
Settings_CameraInvertY      : int (0 or 1)
Settings_MouseSensitivity   : float (10.0 - 300.0)
Settings_BGMVolume          : float (0.0 - 1.0)
Settings_SEVolume           : float (0.0 - 1.0)
```

## セットアップ手順

### 1. Unityエディタでの設定

#### GameUIManagerの設定
1. GameUIManagerオブジェクトのInspectorを開く
2. 「ポーズメニューUI要素」セクションに以下を設定:
   - Camera Invert Y Toggle: カメラ反転Toggle
   - Mouse Sensitivity Slider: マウス感度Slider
   - Mouse Sensitivity Text: マウス感度表示TextMeshProUGUI
   - Bgm Volume Slider: BGMボリュームSlider
   - Bgm Volume Text: BGMボリューム表示TextMeshProUGUI
   - Se Volume Slider: SEボリュームSlider
   - Se Volume Text: SEボリューム表示TextMeshProUGUI
   - Reset To Default Button: デフォルトに戻すButton
   - Resume Button: 再開Button

### 2. UIの構造例

```
PauseMenu (GameObject)
├─ CanvasGroup (Component)
└─ Panel
    ├─ Title (TextMeshPro)
    ├─ Settings Container
    │   ├─ Camera Invert Y
    │   │   ├─ Label (TextMeshPro)
    │   │   └─ Toggle ← cameraInvertYToggle
    │   ├─ Mouse Sensitivity
    │   │   ├─ Label (TextMeshPro)
    │   │   ├─ Slider ← mouseSensitivitySlider
    │   │   └─ Value Text (TextMeshPro) ← mouseSensitivityText
    │   ├─ BGM Volume
    │   │   ├─ Label (TextMeshPro)
    │   │   ├─ Slider ← bgmVolumeSlider
    │   │   └─ Value Text (TextMeshPro) ← bgmVolumeText
    │   └─ SE Volume
    │       ├─ Label (TextMeshPro)
    │       ├─ Slider ← seVolumeSlider
    │       └─ Value Text (TextMeshPro) ← seVolumeText
    ├─ Reset Button ← resetToDefaultButton
    └─ Resume Button ← resumeButton
```

## 利点

### 1. ユーザーカスタマイズ
- カメラ操作を自分好みに調整可能
- オーディオボリュームを個別に調整可能

### 2. 設定の永続化
- PlayerPrefsにより、ゲーム再起動後も設定が保持される
- 毎回設定し直す手間が不要

### 3. 即座反映
- スライダーやToggleを変更すると、即座にゲームに反映
- リアルタイムフィードバックでユーザビリティ向上

### 4. デフォルトリセット機能
- 「デフォルトに戻す」ボタンで簡単に初期状態に戻せる
- 設定を誤った場合でも安心

### 5. 拡張性
- GameSettingsクラスに新しい設定値を追加しやすい
- AudioManager実装時も容易に連携可能（TODO部分）

## 将来の拡張

### AudioManager連携（TODO）
現在、BGMとSEのボリューム設定は保存されますが、実際のオーディオへの反映はコメントアウトされています:
```csharp
// TODO: AudioManagerに反映
// gameManager.AudioManager.SetBGMVolume(value);
// gameManager.AudioManager.SetSEVolume(value);
```
AudioManager実装時に、これらのコメントを外して連携します。

### 追加可能な設定項目
- グラフィック品質設定
- 解像度設定
- フルスクリーン/ウィンドウモード
- キーバインド設定

## テストケース

### ケース1: 設定値の保存と読み込み
1. マウス感度を150%に設定
2. カメラ反転をONに設定
3. ゲームを終了
4. ゲームを再起動
5. **期待結果**: 設定値が保持されている

### ケース2: デフォルトリセット
1. 各設定値を変更
2. 「デフォルトに戻す」ボタンをクリック
3. **期待結果**: すべての設定値がデフォルト値に戻る

### ケース3: 即座反映
1. ポーズメニューを開く
2. マウス感度スライダーを変更
3. ポーズを解除してカメラ操作
4. **期待結果**: 変更した感度が即座に反映されている

## 関連ファイル

- Assets/Scripts/GameManager/GameSettings.cs (新規作成: 114行)
- Assets/Scripts/GameManager/GameUIManager.cs (修正: UI要素追加、設定機能実装)
- Assets/Scripts/Camera/CharacterTracker.cs (修正: カメラ設定連携機能追加)

## 備考

### マウス感度の刻み
マウス感度スライダーは10%刻みで操作できるよう、`OnMouseSensitivityChanged()`内で丸め処理を行っています:
```csharp
float roundedValue = Mathf.Round(value / 10f) * 10f;
```

### PlayerPrefsの保存タイミング
各設定値の変更時に自動的に`SaveSettings()`が呼ばれ、即座にPlayerPrefsに保存されます。これにより、ゲームがクラッシュした場合でも設定値が失われません。

### UnityEditor用using
GameUIManager.csに`#if UNITY_EDITOR`ディレクティブを追加していますが、現時点では使用していません。将来的にエディタ専用機能を追加する際の準備です。
