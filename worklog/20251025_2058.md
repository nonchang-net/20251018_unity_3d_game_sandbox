# ワークログ: GameSoundManagerにサウンドカテゴリー機能を実装

作成日時: 2025-10-25 20:58

## 変更した内容の概要

- SoundCategoryのenumを定義し、BGMとSEの2つのカテゴリーを作成しました
- GameSoundManager.csにカテゴリー別のAudioSource管理機能を実装しました
- カテゴリーごとに一括でボリューム変更ができるようになりました
- GameUIManagerからGameSoundManagerを呼び出し、ポーズメニューのボリューム設定を反映できるようにしました

## なぜそのように変更しようと考えたか

- ポーズメニューのBGMとSEのボリューム設定を実際のサウンドに反映する必要があったため
- AudioSourceを個別に管理するのではなく、カテゴリー単位で一括管理することで、拡張性と保守性を向上させるため
- 将来的にAudioSourceが増えても、カテゴリーに登録するだけでボリューム制御ができるようにするため

## 実装詳細

### 1. SoundCategory enum の定義 (GameSoundManager.cs 21-30行目)

```csharp
/// <summary>
/// サウンドのカテゴリー分類
/// </summary>
public enum SoundCategory
{
    /// <summary>背景音楽</summary>
    BGM,
    /// <summary>サウンドエフェクト</summary>
    SE
}
```

### 2. GameSoundManager.cs の変更

#### 新規追加したフィールド

```csharp
[Header("ボリューム設定")]
private float masterVolume = 1.0f;
private float bgmVolume = 0.8f;  // sfxVolumeとmusicVolumeから変更
private float seVolume = 0.8f;

// カテゴリー別AudioSource管理
private Dictionary<SoundCategory, List<AudioSource>> audioSourcesByCategory = new Dictionary<SoundCategory, List<AudioSource>>();
```

- **audioSourcesByCategory**: カテゴリー別にAudioSourceのリストを管理する辞書
- **bgmVolume / seVolume**: カテゴリー別のボリューム値（従来の`musicVolume`と`sfxVolume`を統一）

#### Awake()の変更 (65-98行目)

```csharp
private void Awake()
{
    // カテゴリー別辞書の初期化
    audioSourcesByCategory[SoundCategory.BGM] = new List<AudioSource>();
    audioSourcesByCategory[SoundCategory.SE] = new List<AudioSource>();

    // BGM用AudioSource
    bgmAudioSource = gameObject.AddComponent<AudioSource>();
    bgmAudioSource.loop = true;
    bgmAudioSource.volume = bgmVolume * masterVolume;
    RegisterAudioSource(bgmAudioSource, SoundCategory.BGM);  // カテゴリーに登録

    // ... BGM再生処理 ...

    // SFX用AudioSource
    sfxAudioSource = gameObject.AddComponent<AudioSource>();
    sfxAudioSource.loop = false;
    sfxAudioSource.volume = seVolume * masterVolume;
    RegisterAudioSource(sfxAudioSource, SoundCategory.SE);  // カテゴリーに登録

    // 警告サウンド用AudioSource
    cautionAudioSource = gameObject.AddComponent<AudioSource>();
    cautionAudioSource.loop = true;
    cautionAudioSource.volume = seVolume * masterVolume;
    RegisterAudioSource(cautionAudioSource, SoundCategory.SE);  // カテゴリーに登録
}
```

#### 新規追加した公開メソッド

**RegisterAudioSource()** (140-158行目)
```csharp
/// <summary>
/// AudioSourceをカテゴリーに登録
/// </summary>
/// <param name="audioSource">登録するAudioSource</param>
/// <param name="category">サウンドカテゴリー</param>
public void RegisterAudioSource(AudioSource audioSource, SoundCategory category)
{
    if (audioSource == null) return;

    if (!audioSourcesByCategory.ContainsKey(category))
    {
        audioSourcesByCategory[category] = new List<AudioSource>();
    }

    if (!audioSourcesByCategory[category].Contains(audioSource))
    {
        audioSourcesByCategory[category].Add(audioSource);
    }
}
```

**UnregisterAudioSource()** (160-173行目)
```csharp
/// <summary>
/// AudioSourceをカテゴリーから登録解除
/// </summary>
/// <param name="audioSource">登録解除するAudioSource</param>
/// <param name="category">サウンドカテゴリー</param>
public void UnregisterAudioSource(AudioSource audioSource, SoundCategory category)
{
    if (audioSource == null) return;

    if (audioSourcesByCategory.ContainsKey(category))
    {
        audioSourcesByCategory[category].Remove(audioSource);
    }
}
```

**SetCategoryVolume()** (175-206行目)
```csharp
/// <summary>
/// 指定カテゴリーの全AudioSourceのボリュームを設定
/// </summary>
/// <param name="category">サウンドカテゴリー</param>
/// <param name="volume">ボリューム（0.0 ～ 1.0）</param>
public void SetCategoryVolume(SoundCategory category, float volume)
{
    volume = Mathf.Clamp01(volume);

    // カテゴリー別のボリューム変数を更新
    switch (category)
    {
        case SoundCategory.BGM:
            bgmVolume = volume;
            break;
        case SoundCategory.SE:
            seVolume = volume;
            break;
    }

    // 該当カテゴリーの全AudioSourceのボリュームを更新
    if (audioSourcesByCategory.ContainsKey(category))
    {
        foreach (var audioSource in audioSourcesByCategory[category])
        {
            if (audioSource != null)
            {
                audioSource.volume = volume * masterVolume;
            }
        }
    }
}
```

**SetBGMVolume()** (208-215行目)
```csharp
/// <summary>
/// BGMボリュームを設定
/// </summary>
/// <param name="volume">ボリューム（0.0 ～ 1.0）</param>
public void SetBGMVolume(float volume)
{
    SetCategoryVolume(SoundCategory.BGM, volume);
}
```

**SetSEVolume()** (217-224行目)
```csharp
/// <summary>
/// SEボリュームを設定
/// </summary>
/// <param name="volume">ボリューム（0.0 ～ 1.0）</param>
public void SetSEVolume(float volume)
{
    SetCategoryVolume(SoundCategory.SE, volume);
}
```

**SetMasterVolume()** (226-237行目)
```csharp
/// <summary>
/// マスターボリュームを設定
/// </summary>
/// <param name="volume">ボリューム（0.0 ～ 1.0）</param>
public void SetMasterVolume(float volume)
{
    masterVolume = Mathf.Clamp01(volume);

    // 全カテゴリーのボリュームを再適用
    SetCategoryVolume(SoundCategory.BGM, bgmVolume);
    SetCategoryVolume(SoundCategory.SE, seVolume);
}
```

#### PlayOneShot()のボリューム値変更

すべての`PlayOneShot()`呼び出しで、`sfxVolume`を`seVolume`に統一:
- `PlayDamagedSound()`: 242-248行目
- `PlayCoinGetSound()`: 250-259行目
- `PlayCheckPointActivatedSound()`: 261-270行目
- `PlayHighJumpSound()`: 272-281行目

### 3. GameManager.cs の変更 (38-39行目)

```csharp
[SerializeField] private GameSoundManager soundManager;
public GameSoundManager SoundManager => soundManager;
```

GameSoundManagerへの参照とgetterを追加

### 4. GameUIManager.cs の変更

#### ApplySoundSettings()の追加 (556-566行目)

```csharp
/// <summary>
/// サウンド設定をSoundManagerに反映
/// </summary>
private void ApplySoundSettings()
{
    if (gameManager?.SoundManager != null)
    {
        gameManager.SoundManager.SetBGMVolume(gameSettings.BGMVolume);
        gameManager.SoundManager.SetSEVolume(gameSettings.SEVolume);
    }
}
```

#### UpdateSettingsUI()の変更 (537-542行目)

```csharp
// カメラ設定をCharacterTrackerに反映
ApplyCameraSettings();

// サウンド設定をSoundManagerに反映
ApplySoundSettings();
```

初期化時にサウンド設定も反映するように変更

#### OnBGMVolumeChanged()の変更 (572-590行目)

```csharp
private void OnBGMVolumeChanged(float value)
{
    gameSettings.SetBGMVolume(value);

    // 表示を更新
    if (bgmVolumeText != null)
    {
        bgmVolumeText.text = $"{value * 100f:F0}%";
    }

    // SoundManagerに反映
    if (gameManager?.SoundManager != null)
    {
        gameManager.SoundManager.SetBGMVolume(value);
    }
}
```

TODO部分を実装し、実際にSoundManagerに反映するように変更

#### OnSEVolumeChanged()の変更 (592-610行目)

```csharp
private void OnSEVolumeChanged(float value)
{
    gameSettings.SetSEVolume(value);

    // 表示を更新
    if (seVolumeText != null)
    {
        seVolumeText.text = $"{value * 100f:F0}%";
    }

    // SoundManagerに反映
    if (gameManager?.SoundManager != null)
    {
        gameManager.SoundManager.SetSEVolume(value);
    }
}
```

TODO部分を実装し、実際にSoundManagerに反映するように変更

## データフロー

### ボリューム変更のフロー

```
ユーザーがスライダーを操作
    ↓
OnBGMVolumeChanged() / OnSEVolumeChanged()
    ├→ GameSettings.SetXXXVolume() (PlayerPrefsに保存)
    ├→ 表示テキストを更新
    └→ GameManager.SoundManager.SetXXXVolume()
        ↓
GameSoundManager.SetCategoryVolume()
    ├→ bgmVolume / seVolume 変数を更新
    └→ audioSourcesByCategory[category]の全AudioSourceのvolumeを更新
        ↓
カテゴリーに登録された全AudioSourceのボリュームが変更される
```

### AudioSourceの登録フロー

```
Awake()でAudioSourceを作成
    ↓
RegisterAudioSource(audioSource, SoundCategory.BGM/SE)
    ↓
audioSourcesByCategory[category].Add(audioSource)
    ↓
カテゴリー別のリストに登録完了
    ↓
以降、SetCategoryVolume()で一括ボリューム変更が可能
```

## カテゴリー管理の仕組み

### Dictionary構造

```csharp
Dictionary<SoundCategory, List<AudioSource>> audioSourcesByCategory
```

```
{
    SoundCategory.BGM: [bgmAudioSource],
    SoundCategory.SE: [sfxAudioSource, cautionAudioSource]
}
```

### ボリューム計算

各AudioSourceのvolume = カテゴリーボリューム × マスターボリューム

例:
- BGM: `audioSource.volume = bgmVolume (0.8) * masterVolume (1.0) = 0.8`
- SE: `audioSource.volume = seVolume (0.8) * masterVolume (1.0) = 0.8`

## 利点

### 1. 一括管理
- カテゴリー単位でボリューム変更ができるため、個別にAudioSourceを管理する必要がない
- 新しいAudioSourceを追加しても、カテゴリーに登録するだけで自動的にボリューム制御対象になる

### 2. 拡張性
- 将来的に新しいカテゴリー（例: VOICE、AMBIENCEなど）を追加しやすい
- enumにカテゴリーを追加し、辞書を初期化するだけで対応可能

### 3. 保守性
- ボリューム変更のロジックが`SetCategoryVolume()`に集約されている
- AudioSourceごとにボリューム計算を書く必要がない

### 4. デバッグ容易性
- どのAudioSourceがどのカテゴリーに属しているか明確
- カテゴリー別のボリューム値を確認しやすい

## 使用例

### AudioSourceを動的に追加する場合

```csharp
// 新しいBGM AudioSourceを追加
AudioSource newBgmSource = gameObject.AddComponent<AudioSource>();
newBgmSource.loop = true;
soundManager.RegisterAudioSource(newBgmSource, SoundCategory.BGM);

// 既存のBGMボリューム設定が自動的に適用される
// SetBGMVolume()を呼ぶと、このAudioSourceも一緒にボリューム変更される
```

### AudioSourceを削除する場合

```csharp
// カテゴリーから登録解除
soundManager.UnregisterAudioSource(myAudioSource, SoundCategory.SE);

// AudioSourceを破棄
Destroy(myAudioSource);
```

## セットアップ手順

### Unityエディタでの設定

1. **GameManagerの設定**:
   - GameManagerオブジェクトのInspectorを開く
   - Sound Manager参照にGameSoundManagerオブジェクトを設定

2. **GameSoundManagerの確認**:
   - 既存のAudioSourceが自動的にカテゴリーに登録される
   - Awake()で初期化されるため、特別な設定は不要

## 動作確認

### 期待される動作
1. **ボリューム変更**: ポーズメニューでBGM/SEスライダーを動かすと、即座にボリュームが変わる
2. **一括変更**: SetBGMVolume()を呼ぶと、BGMカテゴリーの全AudioSourceのボリュームが変わる
3. **設定保持**: ゲーム再起動後も、PlayerPrefsから読み込まれたボリューム設定が反映される

## 既知の制限事項

### PlayOneShot()のボリューム
`PlayOneShot(clip, volume)`の第2引数は、AudioSource自体のvolumeとは独立した値として扱われます。
現在の実装では、`seVolume * masterVolume`を明示的に渡していますが、カテゴリーのボリューム変更が即座にPlayOneShot()に反映されます。

## 将来の拡張案

### 1. カテゴリーの追加
```csharp
public enum SoundCategory
{
    BGM,
    SE,
    VOICE,      // ボイス
    AMBIENCE    // 環境音
}
```

### 2. AudioMixer連携
現在はAudioSource.volumeを直接変更していますが、将来的にAudioMixerを使用することで、より高度なサウンドコントロールが可能になります。

### 3. フェードイン/アウト
カテゴリー単位でフェードイン/アウトする機能を追加可能:
```csharp
public async UniTask FadeCategoryVolume(SoundCategory category, float targetVolume, float duration)
```

## 関連ファイル

- Assets/Sounds/GameSoundManager.cs (修正: カテゴリー管理機能追加)
- Assets/Scripts/GameManager/GameManager.cs (修正: SoundManagerへのgetter追加)
- Assets/Scripts/GameManager/GameUIManager.cs (修正: SoundManager連携実装)

## 備考

### ボリューム変数名の統一
従来の`musicVolume`と`sfxVolume`を、`bgmVolume`と`seVolume`に統一しました。これにより、カテゴリー名と変数名が一致し、コードの可読性が向上しています。

### null安全性
`SetCategoryVolume()`内のforeachループでは、AudioSourceがnullでないかチェックしています。これにより、AudioSourceが破棄された後もエラーが発生しないようになっています。
