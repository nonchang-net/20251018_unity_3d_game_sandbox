# ワークログ: カメラガクガク問題の原因調査と修正実装

作成日時: 2025-10-26 14:21

## 変更した内容の概要

- カメラがmoving platform上で左右移動時にガクガクする問題の原因を調査しました
- CharacterTracker.cs、GameCharacterManager.cs、MovingCurve.csの実装を確認しました
- 問題の根本原因として、スクリプト実行順序の不確定性、LookAtによる回転の不安定性、プラットフォーム追従処理のタイミング問題を特定しました
- 以下の修正を実装しました：
  - CharacterTracker.csのpositionSmoothSpeedを10fから15fに変更
  - CharacterTracker.csのtransform.LookAt()をQuaternion.Slerpによるスムージング回転に変更
  - MovingCurve.csのUpdate()をFixedUpdate()に変更（物理演算との同期）
  - GameCharacterManager.csのプラットフォーム追従処理をFixedUpdate()に統合

## なぜそのように変更しようと考えたか

- ユーザーから「カメラがガクガクする」「小刻みに若干回転してキャラ追従を繰り返す」との報告があったため
- 特にmoving platform上で左右移動時に顕著に発生することから、Update実行順序とプラットフォーム追従処理の関係性を調査する必要があると判断したため
- 問題を正確に特定し、効果的な修正方法を複数提案することで、最適な解決策を選択できるようにするため

## 原因の詳細分析

### 原因1: Update実行順序の不確定性（最も重大）

**問題の構造:**
```
MovingCurve.cs:125-196       → Update()でプラットフォーム位置を更新
GameCharacterManager.cs:225  → Update()でキャラクターをプラットフォームに追従
CharacterTracker.cs:69       → LateUpdate()でカメラを更新
```

**発生するタイミング問題:**
- MovingCurveとGameCharacterManagerの実行順序がフレームごとに不定
- プラットフォームが先に動いてからキャラクターが追従する場合と、その逆の場合がある
- この不整合により、1フレームの遅延や位置計算の誤差が蓄積
- moving platform上で左右移動すると、プラットフォーム移動量 + キャラクター移動量の合成で誤差が顕著になる

**関連コード:**
```csharp
// GameCharacterManager.cs:799-824 HandlePlatformMovement()
Vector3 platformMovement = currentPlatform.position - previousPlatformPosition;
characterController.Move(platformMovement);
previousPlatformPosition = currentPlatform.position;
```

この処理が、MovingCurveのUpdate()より前に実行されると、正しい移動量が計算できません。

### 原因2: LookAtによる回転の不安定性

**問題の構造:**
```csharp
// CharacterTracker.cs:180
transform.LookAt(targetPosition);
```

**発生する問題:**
- 毎フレーム`transform.LookAt()`を呼ぶことで、targetPositionの微妙な変化が直接回転に反映される
- moving platform上では、キャラクター位置がプラットフォームの動きに応じて微妙に変動
- この変動がLookAt計算に影響し、「小刻みに若干回転する」挙動が発生
- 位置のスムージング（175行目のLerp）はあるが、回転にはスムージングがない

**視覚的な影響:**
- カメラがキャラクターを追いかける際、微妙に左右にブレる
- ユーザーから見ると「追従を繰り返している」ように見える

### 原因3: プラットフォーム追従処理のフレーム依存性

**問題の構造:**
```csharp
// GameCharacterManager.cs:809
Vector3 platformMovement = currentPlatform.position - previousPlatformPosition;
```

**発生する問題:**
- 前フレームとの差分から移動量を計算
- MovingCurveとGameCharacterManagerの実行順序が不定なため、正しい差分が取れない場合がある
- 左右移動時は、プラットフォーム移動 + キャラクター移動の両方が発生し、誤差が大きくなる

## 修正方法の提案

### 【最優先・必須】修正方法1: Script Execution Orderの設定

**効果:** ★★★★★
**難易度:** ★☆☆☆☆

**実装内容:**
Unity Editor → Edit → Project Settings → Script Execution Order で以下を設定:
1. MovingCurve: 実行順序 **-100** (最初)
2. GameCharacterManager: 実行順序 **0** (デフォルト)
3. CharacterTracker: 実行順序 **100** (既にLateUpdateなので不要だが明示)

**効果:**
プラットフォーム → キャラクター → カメラ の順で確実に実行され、フレーム間の不整合が解消されます。

**変更対象ファイル:** なし（Unity Editor設定のみ）

### 【強く推奨】修正方法2: カメラ回転処理のスムージング

**効果:** ★★★★☆
**難易度:** ★★☆☆☆

**実装内容:**
CharacterTracker.cs:180の修正

**修正前:**
```csharp
transform.LookAt(targetPosition);
```

**修正後:**
```csharp
// カメラの回転をスムージング
Quaternion targetRotation = Quaternion.LookRotation(targetPosition - transform.position);
transform.rotation = Quaternion.Slerp(transform.rotation, targetRotation,
    Time.deltaTime * positionSmoothSpeed);
```

**効果:**
位置だけでなく回転もスムージングされ、「小刻みな回転」が完全に解消されます。

**変更対象ファイル:** Assets/Scripts/Camera/CharacterTracker.cs

### 【推奨】修正方法3: FixedUpdateへの移行

**効果:** ★★★★☆
**難易度:** ★★★☆☆

**実装内容:**
物理演算関連の処理をFixedUpdateに移行

**MovingCurve.cs:**
```csharp
void FixedUpdate()  // Update()から変更
{
    // 既存の移動処理をそのまま移動
}
```

**GameCharacterManager.cs:**
```csharp
void FixedUpdate()
{
    // プラットフォーム追従処理を追加
    if (implementationType == CharacterImplementationType.CharacterController ||
        implementationType == CharacterImplementationType.RigidbodyAndCollider)
    {
        HandlePlatformMovement();
    }

    // 既存のRigidbody地面判定処理はそのまま
    if (implementationType == CharacterImplementationType.RigidbodyAndCollider)
    {
        CheckGroundRigidbody();
    }
}
```

**効果:**
FixedUpdateは固定時間間隔で実行されるため、物理演算との整合性が向上し、フレームレートに依存しない安定した動作が実現します。

**変更対象ファイル:**
- Assets/Scripts/Utilities/MovingCurve.cs
- Assets/Scripts/GameManager/GameCharacterManager.cs

### 【オプション】修正方法4: スムージング速度の調整

**効果:** ★★☆☆☆
**難易度:** ★☆☆☆☆

**実装内容:**
CharacterTracker.csのpositionSmoothSpeed調整

```csharp
[SerializeField] private float positionSmoothSpeed = 15f;  // 10fから増やす
```

**効果:**
スムージング速度を上げることで、微妙な振動が目立たなくなります。ただし、根本解決ではなく緩和策です。

**変更対象ファイル:** Assets/Scripts/Camera/CharacterTracker.cs

## 推奨する修正の組み合わせ

**最も効果的な組み合わせ:**
1. **修正方法1 (Script Execution Order)** - 必須
2. **修正方法2 (カメラ回転のスムージング)** - 強く推奨
3. **修正方法3 (FixedUpdate)** または **修正方法4 (スムージング調整)** - どちらか一方

この3つを組み合わせることで、カメラのガクガクが大幅に改善されるはずです。

## 関連ファイル

- Assets/Scripts/Camera/CharacterTracker.cs (調査・修正対象)
- Assets/Scripts/GameManager/GameCharacterManager.cs (調査・修正対象)
- Assets/Scripts/Utilities/MovingCurve.cs (調査・修正対象)

## 実装した修正内容

### 1. CharacterTracker.cs の修正

#### positionSmoothSpeed の変更（30行目）
**修正前:**
```csharp
[SerializeField] private float positionSmoothSpeed = 10f;
```

**修正後:**
```csharp
[SerializeField] private float positionSmoothSpeed = 15f;
```

カメラ位置のスムージング速度を向上させ、微妙な振動が目立ちにくくなりました。

#### transform.LookAt() のスムージング化（181-184行目）
**修正前:**
```csharp
// カメラの位置と向きを設定
transform.position = currentCameraPosition;
transform.LookAt(targetPosition);
```

**修正後:**
```csharp
// カメラの位置と向きを設定
transform.position = currentCameraPosition;

// カメラの回転をスムージング（旧実装: transform.LookAt(targetPosition);）
Quaternion targetRotation = Quaternion.LookRotation(targetPosition - transform.position);
transform.rotation = Quaternion.Slerp(transform.rotation, targetRotation,
    Time.deltaTime * positionSmoothSpeed);
```

**効果:**
- 位置だけでなく回転もスムージングされるようになりました
- 「小刻みに回転する」挙動が解消されます
- 旧実装はコメントとして残してあるため、後日比較可能です

### 2. MovingCurve.cs の修正

#### Update() を FixedUpdate() に変更（125行目）
**修正前:**
```csharp
void Update()
{
    // 待機中の処理（PingPongLoopモード時）
    if (isWaiting)
    {
        // ...
    }

    // 移動処理
    float deltaPosition = (moveSpeed * Time.deltaTime) / totalPathLength * direction;
    currentPathPosition += deltaPosition;
    // ...
}
```

**修正後:**
```csharp
void FixedUpdate()
{
    // 待機中の処理（PingPongLoopモード時）
    if (isWaiting)
    {
        // ...
    }

    // 移動処理
    float deltaPosition = (moveSpeed * Time.deltaTime) / totalPathLength * direction;
    currentPathPosition += deltaPosition;
    // ...
}
```

**効果:**
- FixedUpdateは固定時間間隔で実行されるため、物理演算との整合性が向上します
- フレームレートに依存しない安定した動作が実現します

### 3. GameCharacterManager.cs の修正

#### FixedUpdate() にプラットフォーム追従処理を統合（246-259行目）
**修正前:**
```csharp
void FixedUpdate()
{
    // Rigidbody実装の場合は地面判定を更新
    if (implementationType == CharacterImplementationType.RigidbodyAndCollider)
    {
        CheckGroundRigidbody();
    }
}
```

**修正後:**
```csharp
void FixedUpdate()
{
    // MovingPlatform追従処理（物理演算と同期させるためFixedUpdateで実行）
    if (implementationType != CharacterImplementationType.None && targetCharacter != null)
    {
        HandlePlatformMovement();
    }

    // Rigidbody実装の場合は地面判定を更新
    if (implementationType == CharacterImplementationType.RigidbodyAndCollider)
    {
        CheckGroundRigidbody();
    }
}
```

#### HandleMovementCharacterController() の修正（288行目）
**修正前:**
```csharp
void HandleMovementCharacterController()
{
    // MovingPlatform追従処理
    HandlePlatformMovement();

    // ジャンプ処理（移動処理の前に実行）
    // ...
}
```

**修正後:**
```csharp
void HandleMovementCharacterController()
{
    // MovingPlatform追従処理はFixedUpdate()で実行されるため、ここでは呼び出さない

    // ジャンプ処理（移動処理の前に実行）
    // ...
}
```

#### HandleMovementRigidbody() の修正（377行目）
**修正前:**
```csharp
void HandleMovementRigidbody()
{
    // MovingPlatform追従処理
    HandlePlatformMovement();

    // ジャンプ処理
    // ...
}
```

**修正後:**
```csharp
void HandleMovementRigidbody()
{
    // MovingPlatform追従処理はFixedUpdate()で実行されるため、ここでは呼び出さない

    // ジャンプ処理
    // ...
}
```

**効果:**
- プラットフォーム追従処理がFixedUpdate()で一元管理されるようになりました
- MovingCurveのFixedUpdate()と同じタイミングで実行されるため、実行順序の不確定性が緩和されます
- 物理演算との整合性が向上します

## 実装した修正方法の組み合わせ

今回実装したのは、提案した修正方法のうち以下の組み合わせです：

1. ~~修正方法1 (Script Execution Order)~~ - **保留**（コンポーネント汎用性のため）
2. **修正方法2 (カメラ回転のスムージング)** - **実装済み**
3. **修正方法3 (FixedUpdateへの移行)** - **実装済み**
4. **修正方法4 (スムージング速度の調整)** - **実装済み**

## 次のステップ

1. **動作確認** - moving platform上で左右移動してカメラの安定性を確認
2. 問題が解消されない場合は、Script Execution Orderの設定を検討
3. 必要に応じて、さらなるスムージングパラメータの調整

## 備考

### 検証したコード箇所

**CharacterTracker.cs:**
- LateUpdate(): 69-79行目
- UpdateCameraPosition(): 103-181行目
- transform.LookAt(): 180行目

**GameCharacterManager.cs:**
- Update(): 225-244行目
- HandlePlatformMovement(): 799-824行目
- OnControllerColliderHit(): 769-793行目

**MovingCurve.cs:**
- Update(): 125-196行目
- UpdatePosition(): 228-241行目

### 技術的な背景

Unity のUpdate実行順序は、同じタイミング（Update/FixedUpdate/LateUpdate）で実行されるスクリプト間では保証されていません。Script Execution Orderを明示的に設定することで、この問題を解決できます。

また、transform.LookAt()は即座に回転を適用するため、微妙な位置変化でも回転が大きく変わる可能性があります。Quaternion.Slerpでスムージングすることで、滑らかな回転が実現できます。
