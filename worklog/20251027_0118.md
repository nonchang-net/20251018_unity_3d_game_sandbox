# ワークログ: カメラ距離切り替え機能の実装

作成日時: 2025-10-27 01:18

## 変更した内容の概要

- TrackingSettingというScriptableObjectを新規作成し、CharacterTrackerの設定項目（Target Transform以外）を移動しました
- CharacterTrackerをリファクタリングし、TrackingSettingから設定を読み込むように変更しました
- GameStateManagerにカメラビュー切り替えイベント（OnCameraViewChangeRequested）を追加しました
- GameInputManagerのOnZoomToggle()を実装し、Zキーでカメラ切り替えをリクエストできるようにしました
- GameCameraManagerにTogglableTrackingSettings配列を追加し、複数のカメラ設定を切り替えられる機能を実装しました

## なぜそのように変更しようと考えたか

- Zキーを押すたびにカメラ距離を切り替える機能を実装することで、プレイヤーが状況に応じて視点を変更できるようにするため
- カメラ設定をScriptableObjectに分離することで、複数のプリセットを簡単に作成・管理できるようにするため
- 設定をコードから分離することで、デザイナーやプランナーがコードを変更せずにカメラパラメータを調整できるようにするため

## 実装詳細

### 1. TrackingSetting.cs の新規作成

#### ScriptableObjectの定義

```csharp
[CreateAssetMenu(fileName = "TrackingSetting", menuName = "Game/Camera/Tracking Setting", order = 1)]
public class TrackingSetting : ScriptableObject
{
    // カメラ設定
    private float cameraDistance = 6f;
    private float cameraHeight = 2f;
    private bool invertVerticalAxis = false;
    private float mouseSensitivityMultiplier = 1f;

    // カメラ制限
    private float minPitch = -30f;
    private float maxPitch = 70f;
    private float initialPitch = -40f;

    // 障害物回避
    private bool enableCollisionAvoidance = true;
    private float cameraRadius = 0.3f;
    private LayerMask collisionLayers = -1;
    private float collisionSmoothSpeed = 10f;

    // カメラスムージング
    private float positionSmoothSpeed = 15f;
    private float minDistanceThreshold = 0.5f;

    // カメラリセット設定
    private bool resetPitchOnReset = true;
    private float resetPitchAngle = -40f;
}
```

**設計意図:**
- CharacterTrackerで使用していた全てのパラメータをScriptableObjectに移動
- 各パラメータにプロパティを用意し、外部から読み取り専用でアクセス可能
- CreateAssetMenuアトリビュートでUnityエディタから簡単に作成可能

**利点:**
- 複数のカメラプリセット（近距離、中距離、遠距離など）を簡単に作成可能
- 実行時にコードを変更せずにパラメータを調整可能
- プロジェクト間でカメラ設定を再利用可能

### 2. CharacterTracker.cs のリファクタリング

#### 設定項目の移動（CharacterTracker.cs:12-31）

**修正前:**
```csharp
[Header("カメラ設定")]
[SerializeField] private float cameraDistance = 6f;
[SerializeField] private float cameraHeight = 2f;
[SerializeField] private bool invertVerticalAxis = false;
[SerializeField] private float mouseSensitivityMultiplier = 1f;
// ... 他の設定項目も同様
```

**修正後:**
```csharp
[Header("トラッキング設定")]
[Tooltip("カメラトラッキングの設定（ScriptableObject）")]
[SerializeField] private TrackingSetting trackingSetting;

// TrackingSettingから取得するプロパティ
private float cameraDistance => trackingSetting != null ? trackingSetting.CameraDistance : 6f;
private float cameraHeight => trackingSetting != null ? trackingSetting.CameraHeight : 2f;
// ... 他の設定項目も同様にプロパティ化
```

**設計パターン:**
- プロパティを使用して、TrackingSettingから設定値を動的に取得
- TrackingSettingがnullの場合はデフォルト値を返す（フェールセーフ）
- 既存のコードロジックは変更せず、設定の読み込み元のみ変更

#### 新しいメソッドの追加（CharacterTracker.cs:209-230）

```csharp
/// <summary>
/// トラッキング設定を変更
/// </summary>
public void SetTrackingSetting(TrackingSetting newSetting)
{
    trackingSetting = newSetting;

    // 設定変更時にカメラ距離を再初期化
    if (trackingSetting != null)
    {
        currentCameraDistance = trackingSetting.CameraDistance;
    }
}

/// <summary>
/// 現在のトラッキング設定を取得
/// </summary>
public TrackingSetting GetTrackingSetting()
{
    return trackingSetting;
}
```

**機能:**
- SetTrackingSetting(): 実行時にトラッキング設定を変更可能
- 設定変更時にカメラ距離を再初期化することで、スムーズな切り替えを実現
- GetTrackingSetting(): 現在の設定を取得可能

#### 削除したメソッド

以下のメソッドは、TrackingSettingに設定が移動したため削除しました:
- SetCameraDistance()
- SetCameraInvertY()
- SetMouseSensitivity()

### 3. GameStateManager.cs の変更

#### OnCameraViewChangeRequestedの追加（GameStateManager.cs:380-383）

```csharp
/// <summary>
/// カメラビュー切り替えがリクエストされたときに発火するSubject
/// </summary>
public Subject<Unit> OnCameraViewChangeRequested { get; private set; }
```

#### コンストラクタでの初期化（GameStateManager.cs:398）

```csharp
OnCameraViewChangeRequested = new Subject<Unit>();
```

#### RequestNextCameraView()メソッドの追加（GameStateManager.cs:194-200）

```csharp
/// <summary>
/// カメラ切り替えをリクエストする
/// </summary>
public void RequestNextCameraView()
{
    state.OnCameraViewChangeRequested.OnNext(Unit.Default);
}
```

**設計意図:**
- R3のSubjectを使用してイベント駆動型の設計を採用
- カメラ切り替えのリクエストを一元管理
- 複数のコンポーネントがこのイベントを購読可能

### 4. GameInputManager.cs の変更

#### OnZoomToggle()の実装（GameInputManager.cs:148-155）

**修正前:**
```csharp
public void OnZoomToggle(InputAction.CallbackContext context)
{
}
```

**修正後:**
```csharp
public void OnZoomToggle(InputAction.CallbackContext context)
{
    if (context.ReadValue<float>() > 0.5f)
    {
        // カメラビュー切り替えをリクエスト
        gameManager.StateManager.RequestNextCameraView();
    }
}
```

**機能:**
- Zキー（ZoomToggle）の入力を検出
- GameStateManager.RequestNextCameraView()を呼び出し
- 0.5f以上の値でトリガー（キーが押された瞬間のみ反応）

### 5. GameCameraManager.cs の変更

#### 新しいフィールドの追加（GameCameraManager.cs:19-30）

```csharp
[Header("Tracking Settings")]
[Tooltip("切り替え可能なトラッキング設定の配列")]
[SerializeField] private TrackingSetting[] togglableTrackingSettings;

/// <summary>現在のトラッキング設定インデックス</summary>
private int currentTrackingSettingIndex = 0;

/// <summary>R3購読管理</summary>
private IDisposable cameraViewChangeSubscription;
```

**設計:**
- togglableTrackingSettings: 切り替え可能なTrackingSettingの配列
- currentTrackingSettingIndex: 現在適用されている設定のインデックス
- cameraViewChangeSubscription: R3のSubject購読を管理

#### Start()メソッドの拡張（GameCameraManager.cs:47-60）

```csharp
// トラッキング設定の検証
if (togglableTrackingSettings == null || togglableTrackingSettings.Length == 0)
{
    Debug.LogWarning("GameCameraManager: togglableTrackingSettings が設定されていません。カメラ切り替え機能は無効化されます。");
}
else
{
    // 初期設定を適用
    ApplyTrackingSetting(0);
}

// カメラビュー切り替えイベントを購読
SubscribeCameraViewChangeEvents();
```

**機能:**
- 起動時にトラッキング設定配列を検証
- 配列の最初の設定を初期設定として適用
- カメラビュー切り替えイベントを購読

#### OnDestroy()の追加（GameCameraManager.cs:62-66）

```csharp
void OnDestroy()
{
    // R3購読の解放
    cameraViewChangeSubscription?.Dispose();
}
```

**重要性:**
- R3のSubscriptionを適切に破棄してメモリリークを防止

#### SubscribeCameraViewChangeEvents()の実装（GameCameraManager.cs:101-110）

```csharp
/// <summary>
/// カメラビュー切り替えイベントを購読
/// </summary>
private void SubscribeCameraViewChangeEvents()
{
    cameraViewChangeSubscription = gameManager.StateManager.State.OnCameraViewChangeRequested.Subscribe(_ =>
    {
        SwitchToNextTrackingSetting();
    });
}
```

**機能:**
- OnCameraViewChangeRequestedを購読
- イベントが発火したらSwitchToNextTrackingSetting()を呼び出し

#### SwitchToNextTrackingSetting()の実装（GameCameraManager.cs:112-128）

```csharp
/// <summary>
/// 次のトラッキング設定に切り替える
/// </summary>
private void SwitchToNextTrackingSetting()
{
    if (togglableTrackingSettings == null || togglableTrackingSettings.Length == 0)
    {
        Debug.LogWarning("GameCameraManager: togglableTrackingSettings が設定されていないため、カメラ切り替えできません。");
        return;
    }

    // 次のインデックスに進む（ループ）
    currentTrackingSettingIndex = (currentTrackingSettingIndex + 1) % togglableTrackingSettings.Length;

    // 新しい設定を適用
    ApplyTrackingSetting(currentTrackingSettingIndex);
}
```

**ロジック:**
- 配列が空の場合は警告を表示して早期リターン
- インデックスを1つ進める（配列の最後まで行ったらループして0に戻る）
- ApplyTrackingSetting()を呼び出して新しい設定を適用

#### ApplyTrackingSetting()の実装（GameCameraManager.cs:130-159）

```csharp
/// <summary>
/// 指定されたインデックスのトラッキング設定を適用
/// </summary>
private void ApplyTrackingSetting(int index)
{
    if (togglableTrackingSettings == null || index < 0 || index >= togglableTrackingSettings.Length)
    {
        Debug.LogError($"GameCameraManager: 無効なトラッキング設定インデックス {index}");
        return;
    }

    TrackingSetting newSetting = togglableTrackingSettings[index];
    if (newSetting == null)
    {
        Debug.LogError($"GameCameraManager: トラッキング設定 [{index}] が null です。");
        return;
    }

    // CharacterTrackerに新しい設定を適用
    if (gameManager.CharacterTracker != null)
    {
        gameManager.CharacterTracker.SetTrackingSetting(newSetting);
        Debug.Log($"GameCameraManager: トラッキング設定を '{newSetting.name}' に切り替えました。");
    }
    else
    {
        Debug.LogError("GameCameraManager: CharacterTracker が見つかりません。");
    }
}
```

**エラーハンドリング:**
- インデックスの範囲チェック
- TrackingSettingがnullでないかチェック
- CharacterTrackerの存在確認
- 各エラー時に適切なログメッセージを出力

## データフロー

### カメラ切り替えのフロー

```
ユーザーがZキーを押す
  ↓
GameInputManager.OnZoomToggle()
  ↓
GameStateManager.RequestNextCameraView()
  ↓
OnCameraViewChangeRequested.OnNext(Unit.Default)（ReactiveProperty）
  ↓
購読者に通知
  ↓
GameCameraManager.SubscribeCameraViewChangeEvents()
  ↓
SwitchToNextTrackingSetting()
  ├→ currentTrackingSettingIndex++（ループ）
  └→ ApplyTrackingSetting(currentTrackingSettingIndex)
      ↓
      CharacterTracker.SetTrackingSetting(newSetting)
      ↓
      カメラ設定が切り替わる
```

### TrackingSettingの読み込みフロー

```
CharacterTracker.Update()
  ↓
UpdateCameraPosition()
  ├→ cameraDistance プロパティを参照
  │   └→ trackingSetting?.CameraDistance ?? 6f
  ├→ cameraHeight プロパティを参照
  │   └→ trackingSetting?.CameraHeight ?? 2f
  └→ 他のプロパティも同様に参照
      ↓
      TrackingSettingから動的に値を取得
```

## 使用方法

### 1. TrackingSettingの作成

**Unityエディタでの作成:**
1. Project ウィンドウで右クリック
2. Create → Game → Camera → Tracking Setting を選択
3. 名前を設定（例: "TrackingSetting_Near", "TrackingSetting_Far"）
4. Inspector で各パラメータを設定

**プリセット例:**

**近距離カメラ:**
- Camera Distance: 3.0
- Camera Height: 1.5
- Initial Pitch: -20.0

**通常カメラ:**
- Camera Distance: 6.0
- Camera Height: 2.0
- Initial Pitch: -40.0

**遠距離カメラ:**
- Camera Distance: 10.0
- Camera Height: 3.0
- Initial Pitch: -45.0

### 2. GameCameraManagerの設定

**Inspector設定:**
1. GameCameraManager オブジェクトを選択
2. 「Tracking Settings」セクションで「Togglable Tracking Settings」の Size を設定（例: 3）
3. 作成した TrackingSetting をドラッグ＆ドロップで配列に追加
4. 配列の順序が切り替え順序になる

**設定例:**
```
Togglable Tracking Settings:
  [0] TrackingSetting_Near   (近距離)
  [1] TrackingSetting_Normal (通常)
  [2] TrackingSetting_Far    (遠距離)
```

Zキーを押すたびに、近距離 → 通常 → 遠距離 → 近距離 とループします。

### 3. CharacterTrackerの設定

**Inspector設定:**
1. CharacterTracker コンポーネントを選択
2. 「Tracking Setting」に初期設定の TrackingSetting を設定
3. （GameCameraManagerが初期化時に上書きするため、ここでの設定は任意）

## 技術的なポイント

### 1. ScriptableObjectの利点

**再利用性:**
- 一度作成したTrackingSettingを複数のシーンやプロジェクトで再利用可能

**パラメータ調整の容易さ:**
- コードを変更せずに、Inspectorでパラメータを調整可能
- 実行時にパラメータ変更を確認可能

**デザイナーフレンドリー:**
- プログラマーでなくてもカメラパラメータを調整可能

### 2. イベント駆動型設計

**疎結合:**
- GameInputManagerとGameCameraManagerが直接依存しない
- GameStateManagerを介してイベントを伝達

**拡張性:**
- 新しいコンポーネントが簡単にカメラ切り替えイベントを購読可能
- 例: UIにカメラ切り替えボタンを追加する場合も簡単

### 3. フェールセーフ設計

**TrackingSettingがnullの場合:**
```csharp
private float cameraDistance => trackingSetting != null ? trackingSetting.CameraDistance : 6f;
```
- デフォルト値を返すことでエラーを防止

**配列が空の場合:**
```csharp
if (togglableTrackingSettings == null || togglableTrackingSettings.Length == 0)
{
    Debug.LogWarning("...");
    return;
}
```
- 警告を表示して早期リターン

### 4. ループインデックス

```csharp
currentTrackingSettingIndex = (currentTrackingSettingIndex + 1) % togglableTrackingSettings.Length;
```
- モジュロ演算子（%）を使用して、配列の最後まで行ったら0に戻る
- 無限にループ可能

## 今後の拡張案

### 1. カメラ切り替えアニメーション

現在の実装では、カメラ設定が即座に切り替わります。切り替え時にスムーズなアニメーションを追加することで、より自然な視点変更が可能です。

```csharp
// GameCameraManagerに追加
private bool isTransitioning = false;
private TrackingSetting transitionFromSetting;
private TrackingSetting transitionToSetting;
private float transitionProgress = 0f;
private float transitionDuration = 0.5f;

private void Update()
{
    if (isTransitioning)
    {
        UpdateTransition();
    }
}

private void UpdateTransition()
{
    transitionProgress += Time.deltaTime / transitionDuration;

    if (transitionProgress >= 1f)
    {
        isTransitioning = false;
        return;
    }

    // 設定値を補間
    float lerpedDistance = Mathf.Lerp(
        transitionFromSetting.CameraDistance,
        transitionToSetting.CameraDistance,
        transitionProgress
    );
    // 他のパラメータも同様に補間
}
```

### 2. カメラ切り替えUI表示

Zキーを押したときに、現在のカメラモードを画面に表示することで、ユーザビリティを向上できます。

```csharp
// GameUIManagerに追加
public void ShowCameraModeSwitchUI(string modeName)
{
    // 画面に "カメラモード: 近距離" などを表示
    // 2秒後に自動的にフェードアウト
}
```

### 3. カメラモードの制限

特定の状況（例: 狭い場所、イベント中）では遠距離カメラを無効化するなどの制限を追加できます。

```csharp
// GameCameraManagerに追加
private bool[] enabledTrackingSettings;

public void SetTrackingSettingEnabled(int index, bool enabled)
{
    if (index >= 0 && index < enabledTrackingSettings.Length)
    {
        enabledTrackingSettings[index] = enabled;
    }
}

private void SwitchToNextTrackingSetting()
{
    // 有効な設定のみをスキップ
    do
    {
        currentTrackingSettingIndex = (currentTrackingSettingIndex + 1) % togglableTrackingSettings.Length;
    }
    while (!enabledTrackingSettings[currentTrackingSettingIndex]);
}
```

### 4. ショートカットキーのカスタマイズ

現在はZキーのみですが、設定でカスタマイズ可能にすることも検討できます。

### 5. カメラプリセットのホットリロード

実行中にTrackingSettingの値を変更すると即座に反映されるため、ゲームプレイ中にパラメータをチューニング可能です。

## テストケース

### ケース1: 通常のカメラ切り替え

1. TrackingSettingを3つ作成して配列に設定
2. ゲームを開始
3. Zキーを3回押す
4. **期待結果**: 設定が順番に切り替わる（近 → 通常 → 遠 → 近）

### ケース2: TrackingSetting配列が空の場合

1. togglableTrackingSettingsを空にする
2. ゲームを開始
3. Zキーを押す
4. **期待結果**: 警告ログが表示され、何も起こらない

### ケース3: TrackingSettingがnullの場合

1. CharacterTrackerのtrackingSettingをnullにする
2. ゲームを開始
3. **期待結果**: デフォルト値が使用され、カメラが正常に動作

### ケース4: 配列の最後から最初へのループ

1. TrackingSettingを2つ設定
2. Zキーを3回押す
3. **期待結果**: 設定0 → 設定1 → 設定0 とループ

## 利点

### 1. ゲームプレイの向上

- プレイヤーが状況に応じてカメラ距離を変更可能
- 戦闘時は近距離、探索時は遠距離など、柔軟な視点変更

### 2. 開発効率の向上

- ScriptableObjectでカメラプリセットを管理することで、調整が容易
- コードを変更せずにパラメータを調整可能

### 3. 拡張性

- 新しいカメラモードを簡単に追加可能
- 他のコンポーネントがカメラ切り替えイベントを購読可能

### 4. 保守性

- 設定とロジックが分離されているため、コードが読みやすい
- イベント駆動型設計により、コンポーネント間の依存関係が明確

## 関連ファイル

- Assets/Scripts/Camera/TrackingSetting.cs (新規作成: ScriptableObject)
- Assets/Scripts/Camera/CharacterTracker.cs (修正: TrackingSettingを使用するようリファクタリング)
- Assets/Scripts/GameManager/GameStateManager.cs (修正: カメラ切り替えイベント追加)
- Assets/Scripts/GameManager/GameInputManager.cs (修正: OnZoomToggle実装)
- Assets/Scripts/Camera/GameCameraManager.cs (修正: 切り替え機能実装)

## 備考

### InputSystemのZoomToggleアクション

OnZoomToggle()メソッドは、InputSystem_Actions の IPlayerActions インターフェースで定義されている必要があります。もし存在しない場合は、Input Actionアセットに "ZoomToggle" アクションを追加してください。

### TrackingSettingのパラメータ設計

TrackingSettingには全てのカメラパラメータが含まれていますが、実際には以下のパラメータのみを変更するケースが多いでしょう：
- cameraDistance: カメラ距離
- cameraHeight: カメラ高さ
- initialPitch: 初期ピッチ角度

他のパラメータ（障害物回避、スムージングなど）は通常、全てのプリセットで同じ値を使用します。

### ScriptableObjectの保存場所

TrackingSettingは以下の場所に保存することを推奨します：
```
Assets/Settings/Camera/
  ├─ TrackingSetting_Near.asset
  ├─ TrackingSetting_Normal.asset
  └─ TrackingSetting_Far.asset
```

### デバッグログ

ApplyTrackingSetting()では、切り替え時にログを出力しています：
```csharp
Debug.Log($"GameCameraManager: トラッキング設定を '{newSetting.name}' に切り替えました。");
```

リリースビルドでは、このログを無効化することを検討してください。
