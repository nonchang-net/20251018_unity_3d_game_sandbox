# ワークログ: CapsuleColliderの引っかかり問題対処

作成日時: 2025-10-28 18:10

## 変更した内容の概要

- CapsuleCollider実装のキャラクターで横から衝突した際に引っかかる問題に対処しました
- GameCharacterManager.csのRigidbody初期化処理に、衝突検出精度向上と移動の滑らか化設定を追加しました
- Physics Materialの適用を推奨する対処方法を提示しました

## なぜそのように変更しようと考えたか

- CapsuleColliderで横方向に衝突した際、摩擦によって引っかかり、下に落ちずに宙吊りになる問題がありました
- Rigidbodyの衝突検出モードを最適化することで、より正確な物理演算と滑らかな移動を実現できます
- 根本的な解決にはPhysics Materialでの摩擦ゼロ設定が有効ですが、コード側でもベストプラクティスの設定を適用しました

## 実装詳細

### GameCharacterManager.cs の変更

#### Rigidbody設定の最適化（GameCharacterManager.cs:213-217）

**修正前:**
```csharp
// Rigidbodyの設定
characterRigidbody.freezeRotation = true; // 回転を凍結
return;
```

**修正後:**
```csharp
// Rigidbodyの設定
characterRigidbody.freezeRotation = true; // 回転を凍結
characterRigidbody.collisionDetectionMode = CollisionDetectionMode.ContinuousDynamic; // 衝突検出精度を向上
characterRigidbody.interpolation = RigidbodyInterpolation.Interpolate; // 移動を滑らかに
return;
```

**追加した設定の説明:**

1. **CollisionDetectionMode.ContinuousDynamic**
   - 高速移動時の衝突をより正確に検出
   - 動的オブジェクト（キャラクター）が静的オブジェクト（地形）や他の動的オブジェクトとの衝突を連続的にチェック
   - すり抜けやトンネリング現象を防止
   - デフォルトのDiscreteよりも計算コストは高いが、精度が大幅に向上

2. **RigidbodyInterpolation.Interpolate**
   - Update()とFixedUpdate()の間でRigidbodyの位置を補間
   - カクカクした動きを滑らかに
   - 特にカメラがキャラクターを追従する場合に効果的

**なぜこの設定が引っかかり問題に有効か:**
- ContinuousDynamicによって、衝突面に沿ったスライディング挙動がより自然になる
- 引っかかりポイントでの挙動が安定し、Physics Materialの滑り効果が正しく適用される

## 推奨する対処方法の全体像

### 1. Physics Materialの作成と適用（最優先・最も効果的）

**Unity エディタでの作業:**
1. Project ウィンドウで右クリック → Create → Physics Material
2. 名前を「FrictionlessCharacter」に設定
3. Inspector で以下を設定：
   - **Dynamic Friction**: 0（動的摩擦をゼロに）
   - **Static Friction**: 0（静的摩擦をゼロに）
   - **Bounciness**: 0（跳ね返りなし）
   - **Friction Combine**: Minimum（摩擦の合成方法を最小値に）
   - **Bounce Combine**: Minimum（跳ね返りの合成方法を最小値に）

4. キャラクターのCapsuleColliderの「Material」プロパティにドラッグ＆ドロップ

**効果:**
- 摩擦がゼロになるため、横から衝突しても引っかからず滑り落ちる
- 地形との接触面でスライディングが発生し、自然に下方向に移動

### 2. Rigidbody設定の最適化（本実装で対応済み）

GameCharacterManager.csで自動的に最適な設定が適用されます：
- `CollisionDetectionMode.ContinuousDynamic`: 衝突検出精度向上
- `RigidbodyInterpolation.Interpolate`: 移動を滑らかに

### 3. CapsuleColliderの形状最適化

**推奨設定:**
```
Radius: 0.3～0.4（キャラクターサイズに応じて）
Height: Radius × 4 以上（細長いカプセル形状）
Center Y: Height / 2（地面に接する位置を調整）
Direction: Y-Axis
```

**理由:**
- 細長い形状にすることで、底部の接触面積が小さくなり引っかかりにくい
- Radiusが小さいほど、障害物の角に引っかかりにくい

### 4. 追加対策（通常は不要）

Physics Materialだけで解決しない特殊なケースでは、以下の実装を検討：

```csharp
/// <summary>
/// コリジョン接触中の処理（Rigidbody実装用）
/// 横方向の衝突を検出して下方向の力を加える
/// </summary>
void OnCollisionStay(Collision collision)
{
    if (implementationType != CharacterImplementationType.RigidbodyAndCollider)
        return;

    // 各接触点をチェック
    foreach (ContactPoint contact in collision.contacts)
    {
        // 法線ベクトルのY成分が小さい = 横方向の衝突
        if (Mathf.Abs(contact.normal.y) < 0.3f)
        {
            // 下方向の力を加える
            characterRigidbody.AddForce(Vector3.down * 5f, ForceMode.Force);
            break;
        }
    }
}
```

## 問題の原因と解決の仕組み

### 問題の原因

1. **摩擦係数の存在**
   - デフォルトのPhysics Materialは摩擦係数を持つ
   - 横方向の衝突時、摩擦力が重力を上回り宙吊りになる

2. **CapsuleColliderの形状特性**
   - カプセルの側面は曲面だが、障害物の角などで引っかかる
   - 接触面積が大きいと摩擦力も大きくなる

### 解決の仕組み

1. **Physics Materialで摩擦をゼロに**
   - 摩擦力がゼロになり、重力のみが作用
   - 横方向の衝突でもスライドして下に落ちる

2. **ContinuousDynamic collision detection**
   - 衝突判定が正確になり、不自然な挙動が減少
   - スライディング時の挙動が安定

3. **Interpolation**
   - 視覚的な動きが滑らかになり、引っかかりが目立たなくなる

## 検証方法

### テストケース1: 壁への横方向衝突

1. キャラクターを壁に向かって移動
2. 壁に衝突後、ジャンプして壁の側面にぶつける
3. **期待結果**: キャラクターが壁を滑り落ちて地面に着地

### テストケース2: 障害物の角への衝突

1. 箱などの障害物の角に向かってジャンプ
2. 角に横からぶつかる
3. **期待結果**: 角で引っかからず、滑り落ちる

### テストケース3: 斜面での移動

1. 急な斜面を登ろうとする
2. 登れない角度の場合
3. **期待結果**: 摩擦がゼロなので滑り落ちる

## 技術的なポイント

### CollisionDetectionModeの種類と選択基準

| モード | 用途 | 計算コスト |
|--------|------|-----------|
| Discrete | 静止または低速の非重要オブジェクト | 低 |
| Continuous | 動的キャラクター（推奨） | 中 |
| ContinuousDynamic | 動的キャラクター（最高精度） | 高 |
| ContinuousSpeculative | 高速移動+キネマティック | 中～高 |

**今回ContinuousDynamicを選択した理由:**
- プレイヤーキャラクターは重要な動的オブジェクト
- ジャンプや高速移動が想定される
- 精度を最優先し、計算コストは許容範囲

### RigidbodyInterpolationの種類

| モード | 効果 |
|--------|------|
| None | 補間なし（カクカクする可能性） |
| Interpolate | 前フレームとの位置を補間 |
| Extrapolate | 次フレームの位置を予測して補間 |

**今回Interpolateを選択した理由:**
- カメラがキャラクターを追従するため、滑らかさが重要
- Extrapolateは予測誤差の可能性があるため、安定性を優先

### Physics Materialの摩擦合成方法

| Combine方法 | 計算式 | 用途 |
|-------------|--------|------|
| Average | 平均値 | デフォルト |
| Minimum | 最小値 | 滑りやすくしたい場合 |
| Maximum | 最大値 | 摩擦を強くしたい場合 |
| Multiply | 乗算 | 非線形な摩擦 |

**今回Minimumを選択した理由:**
- キャラクター側の摩擦がゼロなら、地形側の摩擦に関わらず常にゼロになる
- 確実に滑りやすくするため

## 利点

### 1. 操作感の向上

- 壁や障害物に引っかからず、スムーズに移動できる
- プレイヤーのストレスが軽減

### 2. 物理挙動の安定性

- ContinuousDynamicにより、高速移動時の衝突も正確に検出
- すり抜けやトンネリング現象を防止

### 3. 視覚的な滑らかさ

- Interpolationにより、カメラ追従時の動きが滑らか
- フレームレートの変動による影響を軽減

### 4. メンテナンス性

- Physics Materialは外部アセットとして管理
- コードを変更せずにパラメータ調整が可能

## 注意点

### 1. 摩擦ゼロの副作用

**問題:**
- 平らな地面でも滑り続ける可能性

**対策:**
- GameCharacterManager.csで速度を減衰させる処理が既に実装済み（HandleMovementRigidbody:443-447）
- 入力がない場合、水平速度をLerpで減衰

### 2. 斜面での挙動

**問題:**
- 摩擦ゼロなので、急な斜面から滑り落ちる

**対策:**
- 必要に応じて、斜面の角度に応じた摩擦制御を実装
- または、キャラクターコントローラーで斜面判定を追加

### 3. 計算コスト

**問題:**
- ContinuousDynamicは計算コストが高い

**対策:**
- プレイヤーキャラクターのみに適用
- NPCや装飾オブジェクトは Discrete または Continuous を使用

## 関連ファイル

- Assets/Scripts/GameManager/GameCharacterManager.cs (修正: Rigidbody設定の最適化)

## 今後の拡張案

### 1. 動的摩擦制御

特定の状況（例: 氷の上、泥の上）で動的に摩擦を変更：

```csharp
public void SetPhysicsMaterial(PhysicMaterial material)
{
    if (characterCollider != null)
    {
        characterCollider.material = material;
    }
}
```

### 2. 地形タイプ別の挙動

地形の種類（草地、氷、泥など）に応じて移動速度や摩擦を変更：

```csharp
void OnCollisionEnter(Collision collision)
{
    if (collision.gameObject.CompareTag("IceSurface"))
    {
        // 氷の上では摩擦をさらに減少
        characterCollider.material = iceMaterial;
    }
}
```

### 3. 壁蹴りアクション

横方向の衝突を検出して、壁蹴りジャンプを実装：

```csharp
void OnCollisionStay(Collision collision)
{
    foreach (ContactPoint contact in collision.contacts)
    {
        if (Mathf.Abs(contact.normal.y) < 0.3f && requestJump)
        {
            // 壁蹴りジャンプ
            Vector3 wallNormal = contact.normal;
            characterRigidbody.AddForce((Vector3.up + wallNormal) * wallKickForce, ForceMode.VelocityChange);
        }
    }
}
```

## 参考リンク

- [Unity Documentation: Rigidbody Collision Detection](https://docs.unity3d.com/Manual/class-Rigidbody.html)
- [Unity Documentation: Physics Material](https://docs.unity3d.com/Manual/class-PhysicMaterial.html)
- [Unity Documentation: Rigidbody Interpolation](https://docs.unity3d.com/ScriptReference/Rigidbody-interpolation.html)

## まとめ

CapsuleColliderの引っかかり問題は、以下の対策で解決しました：

1. **Physics Materialで摩擦をゼロに設定**（最も効果的）
2. **Rigidbodyの衝突検出モードをContinuousDynamicに設定**（本実装で対応）
3. **InterpolationをInterpolateに設定**（本実装で対応）

これにより、キャラクターが壁や障害物に引っかからず、スムーズに動作するようになりました。
